<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Obsidian-Integrated Kanban Task Management</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <style>
    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-tertiary: #0f0f23;
      --text-primary: #eaeaea;
      --text-secondary: #a0a0a0;
      --border-color: #2a2a4a;
      --accent-blue: #4a90d9;
      --accent-green: #4caf50;
      --accent-orange: #ff9800;
      --accent-red: #f44336;
      --accent-yellow: #ffc107;
      --priority-p0: #f44336;
      --priority-p1: #ff9800;
      --priority-p2: #ffc107;
      --priority-p3: #4caf50;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Search Bar */
    .search-container {
      position: relative;
    }

    .search-input {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px 16px;
      color: var(--text-primary);
      width: 300px;
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(74, 144, 217, 0.2);
    }

    .search-input::placeholder {
      color: var(--text-secondary);
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
    }

    .btn-primary:hover {
      background: #3a7fc8;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--border-color);
    }

    .btn-danger {
      background: var(--accent-red);
      color: white;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* Kanban Board - 3 columns filling width */
    .kanban-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      padding: 24px;
      min-height: calc(100vh - 200px);
    }

    @media (max-width: 1024px) {
      .kanban-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .kanban-container {
        grid-template-columns: 1fr;
      }
    }

    .kanban-column {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      min-height: 400px;
    }

    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .column-header h2 {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .task-count {
      background: var(--bg-tertiary);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .add-task-btn {
      background: transparent;
      border: 1px dashed var(--border-color);
      border-radius: 6px;
      width: 28px;
      height: 28px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .add-task-btn:hover {
      border-color: var(--accent-blue);
      color: var(--accent-blue);
      background: rgba(74, 144, 217, 0.1);
    }

    .task-list {
      flex: 1;
      min-height: 200px;
      padding: 4px;
    }

    .task-list.sortable-ghost {
      opacity: 0.4;
    }

    .task-list.sortable-chosen {
      background: rgba(74, 144, 217, 0.1);
      border-radius: 8px;
    }

    /* Task Card */
    .task-card {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 12px;
      cursor: grab;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .task-card:hover {
      border-color: var(--border-color);
      box-shadow: var(--shadow);
      transform: translateY(-2px);
    }

    .task-card.sortable-chosen {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    }

    .task-card[data-priority="P0"] {
      border-left: 3px solid var(--priority-p0);
    }

    .task-card[data-priority="P1"] {
      border-left: 3px solid var(--priority-p1);
    }

    .task-card[data-priority="P2"] {
      border-left: 3px solid var(--priority-p2);
    }

    .task-card[data-priority="P3"] {
      border-left: 3px solid var(--priority-p3);
    }

    .task-card.completed {
      opacity: 0.6;
    }

    .task-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .start-btn-inline {
      background: linear-gradient(135deg, var(--accent-green), #2e7d32);
      border: none;
      border-radius: 4px;
      padding: 3px 10px;
      color: white;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .start-btn-inline:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
    }

    .start-btn-inline:disabled {
      background: var(--border-color);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .start-btn-inline.executing {
      background: linear-gradient(135deg, var(--accent-orange), #ef6c00);
      animation: pulse 1.5s infinite;
    }

    .priority-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .priority-badge.priority-p0 {
      background: rgba(244, 67, 54, 0.2);
      color: var(--priority-p0);
    }

    .priority-badge.priority-p1 {
      background: rgba(255, 152, 0, 0.2);
      color: var(--priority-p1);
    }

    .priority-badge.priority-p2 {
      background: rgba(255, 193, 7, 0.2);
      color: var(--priority-p2);
    }

    .priority-badge.priority-p3 {
      background: rgba(76, 175, 80, 0.2);
      color: var(--priority-p3);
    }

    .task-due {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .task-due.overdue {
      color: var(--accent-red);
    }

    .task-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .task-description {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .task-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    .task-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .tag {
      background: rgba(74, 144, 217, 0.15);
      color: var(--accent-blue);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
    }

    .task-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .task-card:hover .task-actions {
      opacity: 1;
    }

    .icon-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 14px;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }

    .task-files {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color);
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .modal-close {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 24px;
      color: var(--text-secondary);
      padding: 4px;
      line-height: 1;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(74, 144, 217, 0.2);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .priority-selector {
      display: flex;
      gap: 8px;
    }

    .priority-option {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .priority-option:hover {
      border-color: var(--border-color);
    }

    .priority-option.selected {
      border-color: currentColor;
      background: rgba(255, 255, 255, 0.1);
    }

    .priority-option[data-priority="P0"] {
      color: var(--priority-p0);
    }

    .priority-option[data-priority="P1"] {
      color: var(--priority-p1);
    }

    .priority-option[data-priority="P2"] {
      color: var(--priority-p2);
    }

    .priority-option[data-priority="P3"] {
      color: var(--priority-p3);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    /* Active Agents Horizontal Bar */
    .active-agents-bar {
      background: var(--bg-secondary);
      border-radius: 12px;
      margin: 0 24px 24px;
      display: flex;
      gap: 0;
      overflow: hidden;
    }

    .active-agents-section {
      flex: 1;
      padding: 16px;
      border-right: 1px solid var(--border-color);
      min-width: 0;
    }

    .past-sessions-section {
      flex: 1;
      padding: 16px;
      min-width: 0;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .section-header h2 {
      font-size: 1rem;
      font-weight: 600;
    }

    .agent-count, .session-count {
      background: rgba(74, 144, 217, 0.2);
      color: var(--accent-blue);
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .horizontal-agent-list, .horizontal-session-list {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 4px;
      min-height: 100px;
    }

    .horizontal-agent-list::-webkit-scrollbar,
    .horizontal-session-list::-webkit-scrollbar {
      height: 6px;
    }

    .horizontal-agent-list::-webkit-scrollbar-track,
    .horizontal-session-list::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 3px;
    }

    .horizontal-agent-list::-webkit-scrollbar-thumb,
    .horizontal-session-list::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    .empty-agents {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      min-height: 80px;
      color: var(--text-secondary);
      text-align: center;
    }

    .empty-agents .empty-icon {
      font-size: 28px;
      margin-bottom: 4px;
      opacity: 0.6;
    }

    .empty-agents p {
      font-size: 13px;
      margin: 2px 0;
    }

    .horizontal-agent-card {
      flex: 0 0 280px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      padding: 14px;
      border-left: 3px solid var(--accent-blue);
      transition: all 0.2s;
    }

    .horizontal-agent-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .horizontal-agent-card.planning {
      border-left-color: var(--accent-yellow);
    }

    .horizontal-agent-card.executing {
      border-left-color: var(--accent-orange);
      animation: agent-pulse 2s infinite;
    }

    @keyframes agent-pulse {
      0%, 100% { border-left-color: var(--accent-orange); }
      50% { border-left-color: #ffcc80; }
    }

    .horizontal-session-card {
      flex: 0 0 200px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      padding: 12px;
      border-left: 3px solid var(--accent-green);
    }

    .horizontal-session-card.error {
      border-left-color: var(--accent-red);
    }

    .horizontal-session-card.killed {
      border-left-color: var(--accent-orange);
    }

    .agent-card-header, .session-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .agent-card-type {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--accent-blue);
    }

    .agent-card-title, .session-card-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .agent-card-status {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .agent-card-actions {
      display: flex;
      gap: 6px;
    }

    .agent-card-actions button {
      flex: 1;
      padding: 6px 10px;
      font-size: 11px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .agent-btn-kill {
      background: var(--accent-red);
      color: white;
    }

    .agent-btn-kill:hover {
      background: #d32f2f;
    }

    .session-totals-bar {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color);
      font-size: 11px;
      color: var(--text-secondary);
      text-align: center;
    }

    .session-card-meta {
      font-size: 10px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
    }

    /* Status Badge */
    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      text-transform: capitalize;
      font-weight: 500;
    }

    .status-badge.today {
      background: rgba(74, 144, 217, 0.2);
      color: var(--accent-blue);
    }

    .status-badge.tomorrow {
      background: rgba(156, 39, 176, 0.2);
      color: #ce93d8;
    }

    .status-badge.backlog {
      background: rgba(158, 158, 158, 0.2);
      color: #bdbdbd;
    }

    .status-badge.done {
      background: rgba(76, 175, 80, 0.2);
      color: var(--accent-green);
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: var(--shadow);
      animation: toastSlideIn 0.3s ease;
      max-width: 350px;
    }

    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .toast.success {
      border-left: 3px solid var(--accent-green);
    }

    .toast.error {
      border-left: 3px solid var(--accent-red);
    }

    .toast.info {
      border-left: 3px solid var(--accent-blue);
    }

    /* Filter Bar */
    .filter-bar {
      display: flex;
      gap: 12px;
      padding: 0 24px 16px;
      flex-wrap: wrap;
    }

    .filter-chip {
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-chip:hover {
      border-color: var(--accent-blue);
    }

    .filter-chip.active {
      background: rgba(74, 144, 217, 0.2);
      border-color: var(--accent-blue);
      color: var(--accent-blue);
    }

    /* Sync Status */
    .sync-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .sync-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-green);
    }

    .sync-indicator.syncing {
      background: var(--accent-yellow);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Task Detail Modal */
    .detail-section {
      margin-bottom: 16px;
    }

    .detail-section h3 {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .detail-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* File Management Styles */
    .file-upload-area {
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 16px;
    }

    .file-upload-area:hover,
    .file-upload-area.dragover {
      border-color: var(--accent-blue);
      background: rgba(74, 144, 217, 0.1);
    }

    .file-upload-area input[type="file"] {
      display: none;
    }

    .file-upload-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.6;
    }

    .file-upload-text {
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .file-upload-hint {
      font-size: 12px;
      color: var(--text-secondary);
      opacity: 0.7;
    }

    .file-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .file-item:last-child {
      margin-bottom: 0;
    }

    .file-thumbnail {
      width: 48px;
      height: 48px;
      border-radius: 6px;
      object-fit: cover;
      background: var(--border-color);
    }

    .file-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: var(--border-color);
      border-radius: 6px;
    }

    .file-info {
      flex: 1;
      min-width: 0;
    }

    .file-name {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-meta {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .file-actions {
      display: flex;
      gap: 4px;
    }

    .upload-progress {
      height: 4px;
      background: var(--border-color);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 12px;
    }

    .upload-progress-bar {
      height: 100%;
      background: var(--accent-blue);
      transition: width 0.3s;
    }

    .attached-files-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    .attached-files-title {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(74, 144, 217, 0.15);
      border-radius: 6px;
      font-size: 12px;
      margin: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .file-tag:hover {
      background: rgba(74, 144, 217, 0.25);
    }

    .file-tag img {
      width: 16px;
      height: 16px;
      border-radius: 2px;
    }

    /* ============================================
       PHASE 2: AGENT EXECUTION UI ENHANCEMENTS
       ============================================ */

    /* Task Card Controls Row */
    .task-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      flex-wrap: wrap;
    }

    .agent-type-select {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 4px 8px;
      color: var(--text-primary);
      font-size: 11px;
      cursor: pointer;
      min-width: 100px;
    }

    .agent-type-select:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .plan-first-label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--text-secondary);
      cursor: pointer;
      user-select: none;
    }

    .plan-first-checkbox {
      width: 14px;
      height: 14px;
      cursor: pointer;
      accent-color: var(--accent-blue);
    }

    .start-btn {
      background: linear-gradient(135deg, var(--accent-green), #2e7d32);
      border: none;
      border-radius: 4px;
      padding: 4px 10px;
      color: white;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
      margin-left: auto;
    }

    .start-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
    }

    .start-btn:disabled {
      background: var(--border-color);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .start-btn.executing {
      background: linear-gradient(135deg, var(--accent-orange), #ef6c00);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Status Badges */
    .agent-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      margin-left: auto; /* Push to right side of header */
    }

    .agent-status-badge.status-draft {
      background: rgba(160, 160, 160, 0.2);
      color: #a0a0a0;
    }

    .agent-status-badge.status-plan-pending {
      background: rgba(255, 193, 7, 0.2);
      color: var(--accent-yellow);
    }

    .agent-status-badge.status-planning {
      background: rgba(74, 144, 217, 0.2);
      color: var(--accent-blue);
      animation: pulse 2s infinite;
    }

    .agent-status-badge.status-plan-ready {
      background: rgba(156, 39, 176, 0.2);
      color: #ce93d8;
    }

    .agent-status-badge.status-executing {
      background: rgba(255, 152, 0, 0.2);
      color: var(--accent-orange);
      animation: pulse 1s infinite;
    }

    .agent-status-badge.status-complete {
      background: rgba(76, 175, 80, 0.2);
      color: var(--accent-green);
    }

    .agent-status-badge.status-error {
      background: rgba(244, 67, 54, 0.2);
      color: var(--accent-red);
    }

    /* Session View Column */
    .session-view-column {
      background: linear-gradient(180deg, var(--bg-secondary) 0%, rgba(74, 144, 217, 0.05) 100%);
      border: 1px solid rgba(74, 144, 217, 0.2);
    }

    .session-view-column .column-header h2 {
      color: var(--accent-blue);
    }

    .session-list {
      flex: 1;
      min-height: 200px;
      padding: 4px;
    }

    .session-card {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 3px solid var(--accent-blue);
      transition: all 0.2s;
    }

    .session-card:hover {
      transform: translateX(2px);
      box-shadow: var(--shadow);
    }

    .session-card.planning {
      border-left-color: var(--accent-yellow);
    }

    .session-card.executing {
      border-left-color: var(--accent-orange);
      animation: subtle-pulse 2s infinite;
    }

    @keyframes subtle-pulse {
      0%, 100% { border-left-color: var(--accent-orange); }
      50% { border-left-color: #ffcc80; }
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .session-type {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent-blue);
      text-transform: uppercase;
    }

    /* ============================================
       DONE SECTION - Reports Bar Styles
       ============================================ */
    .done-section {
      background: var(--bg-secondary);
      border-top: 3px solid var(--accent-green);
      padding: 20px 24px;
      margin-top: 20px;
    }

    .done-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .done-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .done-title h2 {
      font-size: 1.2rem;
      color: var(--accent-green);
    }

    .report-count {
      background: rgba(76, 175, 80, 0.2);
      color: var(--accent-green);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .done-actions {
      display: flex;
      gap: 8px;
    }

    .reports-container {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding: 8px 4px 16px;
      scroll-behavior: smooth;
    }

    .reports-container::-webkit-scrollbar {
      height: 8px;
    }

    .reports-container::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    .reports-container::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    .reports-container::-webkit-scrollbar-thumb:hover {
      background: var(--accent-green);
    }

    .report-card {
      flex: 0 0 380px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--border-color);
      border-left: 4px solid var(--accent-green);
      transition: all 0.2s;
      cursor: pointer;
    }

    .report-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      border-color: var(--accent-green);
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .report-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.4;
      flex: 1;
      margin-right: 8px;
    }

    .report-priority {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
    }

    .report-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    .report-stat {
      text-align: center;
    }

    .report-stat-value {
      font-size: 16px;
      font-weight: bold;
      color: var(--text-primary);
    }

    .report-stat-label {
      font-size: 9px;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .report-files {
      margin-bottom: 10px;
    }

    .report-files-title {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .report-file-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .report-file-tag {
      background: rgba(255, 152, 0, 0.15);
      color: var(--accent-orange);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-family: monospace;
    }

    .report-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 10px;
      border-top: 1px solid var(--border-color);
      font-size: 11px;
      color: var(--text-secondary);
    }

    .empty-reports {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
      width: 100%;
    }

    .empty-icon {
      font-size: 40px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Archive Modal */
    .archive-modal {
      max-width: 900px;
      width: 95%;
      max-height: 80vh;
    }

    .archive-list {
      max-height: 500px;
      overflow-y: auto;
      padding: 8px;
    }

    .archive-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid var(--border-color);
    }

    .archive-item:hover {
      border-color: var(--accent-blue);
    }

    .archive-item-info {
      flex: 1;
    }

    .archive-item-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .archive-item-meta {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .archive-item-actions {
      display: flex;
      gap: 8px;
    }

    .session-type.planning {
      color: var(--accent-yellow);
    }

    .session-type.executing {
      color: var(--accent-orange);
    }

    .session-time {
      font-size: 10px;
      color: var(--text-secondary);
      font-family: monospace;
    }

    .session-task-title {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-agent {
      font-size: 10px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .session-step {
      font-size: 10px;
      color: var(--accent-blue);
      margin-bottom: 8px;
      padding: 4px 8px;
      background: rgba(74, 144, 217, 0.1);
      border-radius: 4px;
    }

    .session-actions {
      display: flex;
      gap: 6px;
    }

    .session-btn {
      flex: 1;
      padding: 4px 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .session-btn:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }

    .session-btn.kill {
      border-color: var(--accent-red);
      color: var(--accent-red);
    }

    .session-btn.kill:hover {
      background: var(--accent-red);
      color: white;
    }

    .empty-sessions {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-sessions-icon {
      font-size: 40px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Plan Review Modal */
    .plan-review-modal {
      max-width: 800px;
      width: 95%;
    }

    .plan-review-content {
      max-height: 60vh;
      overflow-y: auto;
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 20px;
      margin: 16px 0;
      border: 1px solid var(--border-color);
    }

    .plan-review-content pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-primary);
    }

    .plan-review-content h1,
    .plan-review-content h2,
    .plan-review-content h3 {
      margin-top: 16px;
      margin-bottom: 8px;
    }

    .plan-review-content ul,
    .plan-review-content ol {
      margin-left: 20px;
      margin-bottom: 12px;
    }

    .plan-review-content li {
      margin-bottom: 4px;
    }

    .plan-metadata {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .plan-meta-item {
      background: var(--bg-tertiary);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .plan-meta-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .plan-meta-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .plan-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    .plan-actions .btn {
      min-width: 120px;
      justify-content: center;
    }

    /* Execution Progress Indicator */
    .execution-progress {
      position: fixed;
      top: 80px;
      right: 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      min-width: 280px;
      box-shadow: var(--shadow);
      z-index: 150;
      display: none;
    }

    .execution-progress.active {
      display: block;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .execution-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .execution-progress-title {
      font-size: 14px;
      font-weight: 600;
    }

    .execution-progress-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
    }

    .execution-progress-bar {
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .execution-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .execution-progress-text {
      font-size: 12px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <h1>üìã Kanban Board</h1>
    <div class="header-actions">
      <div class="sync-status">
        <span class="sync-indicator" id="syncIndicator"></span>
        <span id="syncStatusText">Synced</span>
      </div>
      <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Search tasks...">
      </div>
      <button class="btn btn-secondary" onclick="refreshTasks()">üîÑ Refresh</button>
      <button class="btn btn-primary" onclick="openNewTaskModal()">+ New Task</button>
    </div>
  </header>

  <!-- Active Agents Horizontal Bar -->
  <div class="active-agents-bar" id="activeAgentsBar">
    <div class="active-agents-section">
      <div class="section-header">
        <h2>ü§ñ Active Agents</h2>
        <span class="agent-count" id="activeAgentCount">0</span>
        <button class="btn btn-small btn-secondary" onclick="refreshSessions()">üîÑ Refresh</button>
      </div>
      <div class="horizontal-agent-list" id="horizontalAgentList">
        <div class="empty-agents">
          <span class="empty-icon">ü§ñ</span>
          <p>No active agents</p>
          <p style="font-size: 12px; opacity: 0.7;">Start a task to see it here</p>
        </div>
      </div>
    </div>
    
    <div class="past-sessions-section">
      <div class="section-header">
        <h2>üìä Past Sessions</h2>
        <span class="session-count" id="horizontalSessionCount">0</span>
        <button class="btn btn-small btn-secondary" onclick="refreshSessions()">üîÑ Refresh</button>
      </div>
      <div class="horizontal-session-list" id="horizontalSessionList">
        <div class="empty-agents" id="emptyPastSessions">
          <span class="empty-icon">üìä</span>
          <p>No completed sessions</p>
          <p style="font-size: 12px; opacity: 0.7;">Execute tasks to see them here</p>
        </div>
      </div>
      <div class="session-totals-bar" id="horizontalSessionTotals">
        Total: $0.000 | 0 min | 0 sessions
      </div>
    </div>
  </div>

  <!-- Filter Bar -->
  <div class="filter-bar" id="filterBar">
    <button class="filter-chip active" data-filter="all">All</button>
    <button class="filter-chip" data-filter="P0">P0</button>
    <button class="filter-chip" data-filter="P1">P1</button>
    <button class="filter-chip" data-filter="P2">P2</button>
    <button class="filter-chip" data-filter="P3">P3</button>
    <div style="flex: 1;"></div>
    <button class="btn btn-small btn-secondary" onclick="openCommandPalette()">‚å®Ô∏è Commands</button>
    <button class="btn btn-small btn-secondary" onclick="showKeyboardShortcuts()">‚å®Ô∏è Shortcuts</button>
    <button class="btn btn-small btn-secondary" onclick="toggleTheme()">üåó Theme</button>
  </div>

  <!-- Kanban Board -->
  <div class="kanban-container" id="kanbanContainer">
    <!-- Backlog Column -->
    <div class="kanban-column" data-column="backlog">
      <div class="column-header">
        <h2>üìö Backlog</h2>
        <span class="task-count" id="count-backlog">0</span>
        <button class="add-task-btn" data-status="backlog" onclick="openNewTaskModal('backlog')">+</button>
      </div>
      <div class="task-list sortable" id="tasks-backlog" data-status="backlog"></div>
    </div>

    <!-- Today Column -->
    <div class="kanban-column" data-column="today">
      <div class="column-header">
        <h2>üìÖ Today</h2>
        <span class="task-count" id="count-today">0</span>
        <button class="add-task-btn" data-status="today" onclick="openNewTaskModal('today')">+</button>
      </div>
      <div class="task-list sortable" id="tasks-today" data-status="today"></div>
    </div>

    <!-- Tomorrow Column -->
    <div class="kanban-column" data-column="tomorrow">
      <div class="column-header">
        <h2>üåÖ Tomorrow</h2>
        <span class="task-count" id="count-tomorrow">0</span>
        <button class="add-task-btn" data-status="tomorrow" onclick="openNewTaskModal('tomorrow')">+</button>
      </div>
      <div class="task-list sortable" id="tasks-tomorrow" data-status="tomorrow"></div>
    </div>
  </div>

  <!-- ============================================
       DONE SECTION - Reports Bar (Horizontal)
       ============================================ -->
  <div class="done-section" id="doneSection">
    <div class="done-header">
      <div class="done-title">
        <h2>üìä Done - Execution Reports</h2>
        <span class="report-count" id="reportCount">0 reports</span>
      </div>
      <div class="done-actions">
        <button class="btn btn-small btn-secondary" onclick="refreshReports()">üîÑ Refresh</button>
        <button class="btn btn-small btn-secondary" onclick="showArchiveView()">üì¶ Archive</button>
        <button class="btn btn-small btn-secondary" onclick="clearAllReports()">üóëÔ∏è Clear All</button>
      </div>
    </div>
    <div class="reports-container" id="reportsContainer">
      <div class="empty-reports" id="emptyReports">
        <div class="empty-icon">üìã</div>
        <p>No completed tasks yet</p>
        <p style="font-size: 13px; margin-top: 8px; opacity: 0.7;">Execute tasks to see reports here</p>
      </div>
    </div>
  </div>

  <!-- New/Edit Task Modal -->
  <div class="modal-overlay" id="taskModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">New Task</h2>
        <button class="modal-close" onclick="closeTaskModal()">&times;</button>
      </div>
      <form id="taskForm" onsubmit="handleTaskSubmit(event)">
        <input type="hidden" id="taskId">
        <input type="hidden" id="taskStatus">
        
        <div class="form-group">
          <label for="taskTitle">Title *</label>
          <input type="text" class="form-input" id="taskTitle" required placeholder="What needs to be done?">
        </div>
        
        <div class="form-group">
          <label for="taskDescription">Description</label>
          <textarea class="form-textarea" id="taskDescription" placeholder="Add details about this task..."></textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="taskPriority">Priority</label>
            <div class="priority-selector" id="prioritySelector">
              <div class="priority-option selected" data-priority="P3">P3</div>
              <div class="priority-option" data-priority="P2">P2</div>
              <div class="priority-option" data-priority="P1">P1</div>
              <div class="priority-option" data-priority="P0">P0</div>
            </div>
            <input type="hidden" id="taskPriority" value="P2">
          </div>
          
          <div class="form-group">
            <label for="taskDueDate">Due Date</label>
            <input type="date" class="form-input" id="taskDueDate">
          </div>
        </div>
        
        <div class="form-group">
          <label for="taskTags">Tags (comma-separated)</label>
          <input type="text" class="form-input" id="taskTags" placeholder="development, ai, urgent">
        </div>
        
        <!-- Agent Settings (moved from card to modal) -->
        <div class="form-row">
          <div class="form-group">
            <label for="taskAgentType">Agent Type</label>
            <select class="form-select" id="taskAgentType">
              <option value="auto">ü§ñ Auto</option>
              <option value="ui-designer">üé® UI Designer</option>
              <option value="researcher">üîç Researcher</option>
              <option value="coder">üíª Coder</option>
              <option value="writer">‚úçÔ∏è Writer</option>
              <option value="planner">üìã Planner</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="plan-first-label" style="display: flex; align-items: center; gap: 8px; margin-top: 24px; cursor: pointer;">
              <input type="checkbox" id="taskPlanFirst" style="width: 18px; height: 18px;">
              <span>Plan First</span>
            </label>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">Cancel</button>
          <button type="button" class="btn btn-danger" id="deleteBtn" onclick="deleteTask()" style="display: none;">Delete</button>
          <button type="submit" class="btn btn-primary">Save Task</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div class="modal-overlay" id="detailModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="detailTitle">Task Details</h2>
        <button class="modal-close" onclick="closeDetailModal()">&times;</button>
      </div>
      <div id="detailContent"></div>
      <div class="attached-files-section" id="attachedFilesSection" style="display: none;">
        <div class="attached-files-title">
          <span>üìé</span> Attached Files
          <button class="btn btn-small btn-secondary" onclick="openFileManager()">+ Add</button>
        </div>
        <div id="attachedFilesList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>
        <button class="btn btn-primary" id="editFromDetailBtn" onclick="editFromDetail()">Edit Task</button>
      </div>
    </div>
  </div>

  <!-- File Manager Modal -->
  <div class="modal-overlay" id="fileModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2>üìÅ File Manager</h2>
        <button class="modal-close" onclick="closeFileModal()">√ó</button>
      </div>
      
      <div class="form-group" id="fileTaskSelector" style="display: none;">
        <label>Attach to Task</label>
        <select class="form-select" id="fileTaskSelect" onchange="loadTaskFiles()">
          <option value="">Select a task...</option>
        </select>
      </div>
      
      <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()"
           ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
        <div class="file-upload-icon">üì§</div>
        <div class="file-upload-text">Drop files here or click to upload</div>
        <div class="file-upload-hint">Supports images, documents, code files (max 50MB)</div>
        <input type="file" id="fileInput" multiple onchange="handleFileSelect(event)">
      </div>
      
      <div id="uploadProgress" style="display: none;">
        <div class="upload-progress">
          <div class="upload-progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;" id="uploadStatus">Uploading...</p>
      </div>
      
      <div class="file-list" id="fileList"></div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeFileModal()">Close</button>
      </div>
    </div>
  </div>
  <!-- Archive Modal -->
  <div class="modal-overlay" id="archiveModal">
    <div class="modal archive-modal">
      <div class="modal-header">
        <h2>üì¶ Archived Tasks</h2>
        <button class="modal-close" onclick="closeArchiveModal()">&times;</button>
      </div>
      <div class="archive-list" id="archiveList">
        <div class="empty-reports">
          <div class="empty-icon">üì¶</div>
          <p>No archived tasks</p>
          <p style="font-size: 13px; margin-top: 8px; opacity: 0.7;">Completed tasks appear here</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeArchiveModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Report Detail Modal -->
  <div class="modal-overlay" id="reportDetailModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2>üìä Execution Report</h2>
        <button class="modal-close" onclick="closeReportDetailModal()">&times;</button>
      </div>
      <div id="reportDetailContent"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeReportDetailModal()">Close</button>
        <button class="btn btn-primary" onclick="restoreFromReport()">üì¶ Restore Task</button>
      </div>
    </div>
  </div>

  <!-- Plan Review Modal (Phase 2) -->
  <div class="modal-overlay" id="planReviewModal">
    <div class="modal plan-review-modal">
      <div class="modal-header">
        <h2>üìã Review Plan</h2>
        <button class="modal-close" onclick="closePlanReviewModal()">√ó</button>
      </div>
      
      <div id="planReviewTaskInfo" style="margin-bottom: 12px;">
        <h3 id="planReviewTaskTitle" style="font-size: 16px; font-weight: 600;"></h3>
      </div>
      
      <div class="plan-metadata" id="planMetadata">
        <div class="plan-meta-item">
          <div class="plan-meta-label">Agent Type</div>
          <div class="plan-meta-value" id="planMetaAgent">Auto</div>
        </div>
        <div class="plan-meta-item">
          <div class="plan-meta-label">Created</div>
          <div class="plan-meta-value" id="planMetaCreated">-</div>
        </div>
        <div class="plan-meta-item">
          <div class="plan-meta-label">Steps</div>
          <div class="plan-meta-value" id="planMetaSteps">-</div>
        </div>
      </div>
      
      <div class="plan-review-content" id="planReviewContent">
        <p style="text-align: center; color: var(--text-secondary);">Loading plan...</p>
      </div>
      
      <div class="plan-actions">
        <button class="btn btn-secondary" onclick="editPlan()">‚úèÔ∏è Edit Plan</button>
        <button class="btn btn-secondary" onclick="regeneratePlan()">üîÑ Regenerate</button>
        <button class="btn btn-danger" onclick="closePlanReviewModal()">Cancel</button>
        <button class="btn btn-primary" onclick="approveAndExecute()">‚úÖ Approve & Run</button>
      </div>
    </div>
  </div>

  <!-- Execution Progress Panel (Phase 2) -->
  <div class="execution-progress" id="executionProgress">
    <div class="execution-progress-header">
      <span class="execution-progress-title">‚ö° Executing Task</span>
      <button class="execution-progress-close" onclick="hideExecutionProgress()">√ó</button>
    </div>
    <div class="execution-progress-bar">
      <div class="execution-progress-fill" id="executionProgressFill" style="width: 0%"></div>
    </div>
    <div class="execution-progress-text" id="executionProgressText">Starting...</div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ============================================
    // STATE MANAGEMENT
    // ============================================
    const API_BASE = 'http://localhost:3001/api/v1';
    let tasks = [];
    let currentFilter = 'all';
    let currentDetailTask = null;

    // ============================================
    // API FUNCTIONS
    // ============================================
    async function fetchTasks(filters = {}) {
      try {
        const params = new URLSearchParams();
        if (filters.status) params.append('status', filters.status);
        if (filters.priority) params.append('priority', filters.priority);
        if (filters.search) params.append('search', filters.search);
        
        const response = await fetch(`${API_BASE}/tasks?${params}`);
        const data = await response.json();
        return data.tasks || [];
      } catch (err) {
        console.error('Error fetching tasks:', err);
        showToast('Failed to fetch tasks', 'error');
        return [];
      }
    }

    async function createTask(taskData) {
      try {
        const response = await fetch(`${API_BASE}/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(taskData)
        });
        const task = await response.json();
        showToast('Task created successfully', 'success');
        return task;
      } catch (err) {
        console.error('Error creating task:', err);
        showToast('Failed to create task', 'error');
        throw err;
      }
    }

    async function updateTask(taskId, updates) {
      try {
        const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        });
        const task = await response.json();
        showToast('Task updated', 'success');
        return task;
      } catch (err) {
        console.error('Error updating task:', err);
        showToast('Failed to update task', 'error');
        throw err;
      }
    }

    async function moveTask(taskId, newStatus) {
      try {
        const response = await fetch(`${API_BASE}/tasks/${taskId}/move`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        return await response.json();
      } catch (err) {
        console.error('Error moving task:', err);
        showToast('Failed to move task', 'error');
        throw err;
      }
    }

    async function deleteTaskById(taskId) {
      try {
        await fetch(`${API_BASE}/tasks/${taskId}`, { method: 'DELETE' });
        showToast('Task deleted', 'success');
        return true;
      } catch (err) {
        console.error('Error deleting task:', err);
        showToast('Failed to delete task', 'error');
        throw err;
      }
    }

    async function getSuggestion() {
      try {
        const response = await fetch(`${API_BASE}/suggestions/next`);
        return await response.json();
      } catch (err) {
        console.error('Error getting suggestion:', err);
        return null;
      }
    }

    async function syncObsidian() {
      try {
        await fetch(`${API_BASE}/sync/obsidian/push`, { method: 'POST' });
        await fetch(`${API_BASE}/sync/obsidian/pull`, { method: 'POST' });
        showToast('Synced with Obsidian', 'success');
      } catch (err) {
        console.error('Error syncing with Obsidian:', err);
        showToast('Failed to sync with Obsidian', 'error');
      }
    }

    // ============================================
    // UI FUNCTIONS
    // ============================================
    
    // Phase 2: Get status badge HTML - shows plan/execution status
    function getAgentStatusBadge(task) {
      const status = task.executionStatus || 'draft';
      
      // Simplified status config - no 'complete' since tasks auto-archive
      const statusConfig = {
        'draft': { icon: 'üìù', label: 'Draft', class: 'status-draft', show: true },
        'plan-pending': { icon: 'üìã', label: 'Plan Pending', class: 'status-plan-pending', show: true },
        'planning': { icon: 'üîÑ', label: 'Planning', class: 'status-planning', show: true },
        'plan-ready': { icon: '‚úÖ', label: 'Plan Ready', class: 'status-plan-ready', show: true },
        'executing': { icon: '‚ö°', label: 'Executing', class: 'status-executing', show: true },
        'error': { icon: '‚ùå', label: 'Error', class: 'status-error', show: true },
        'complete': { icon: '‚úì', label: 'Complete', class: 'status-complete', show: false } // Hidden - tasks auto-archive
      };
      
      const config = statusConfig[status];
      if (!config || !config.show) return '';
      return `<span class="agent-status-badge ${config.class}">${config.icon} ${config.label}</span>`;
    }
    
    function renderTaskCard(task) {
      const dueDate = task.dueDate ? new Date(task.dueDate) : null;
      const isOverdue = dueDate && dueDate < new Date() && task.status !== 'done';
      
      const tagsHtml = task.tags && task.tags.length 
        ? `<div class="task-tags">${task.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>` 
        : '';
      
      const filesHtml = task.files && task.files.length
        ? `<div class="task-files"><span>üìé</span> ${task.files.length} file${task.files.length > 1 ? 's' : ''}</div>`
        : '';
      
      // Phase 2: Agent type options
      const agentTypes = [
        { value: 'auto', label: 'ü§ñ Auto' },
        { value: 'ui-designer', label: 'üé® UI Designer' },
        { value: 'researcher', label: 'üîç Researcher' },
        { value: 'coder', label: 'üíª Coder' },
        { value: 'writer', label: '‚úçÔ∏è Writer' },
        { value: 'planner', label: 'üìã Planner' }
      ];
      
      const currentAgentType = task.agentType || 'auto';
      const isExecuting = task.executionStatus === 'executing' || task.executionStatus === 'planning';
      const planFirstChecked = task.planFirst ? 'checked' : '';
      
      // Phase 2: Build agent type dropdown options
      const agentOptions = agentTypes.map(type => 
        `<option value="${type.value}" ${currentAgentType === type.value ? 'selected' : ''}>${type.label}</option>`
      ).join('');
      
      // Phase 2: Determine start button state
      const startBtnText = isExecuting ? '‚è∏ Running...' : '‚ñ∂ Start';
      const startBtnClass = isExecuting ? 'executing' : '';
      const startBtnDisabled = isExecuting ? 'disabled' : '';
      
      return `
        <div class="task-card ${task.status === 'done' ? 'completed' : ''}" 
             data-task-id="${task.id}" 
             data-priority="${task.priority}"
             onclick="editTask('${task.id}')">
          
          <div class="task-header">
            <span class="priority-badge priority-${task.priority.toLowerCase()}">${task.priority}</span>
            
            <!-- Start Button moved to header -->
            <button class="start-btn-inline ${startBtnClass}" ${startBtnDisabled}
                    onclick="event.stopPropagation(); startTaskExecution('${task.id}')"
                    title="Start task execution">
              ${startBtnText}
            </button>
            
            ${getAgentStatusBadge(task)}
          </div>
          
          <h3 class="task-title">${escapeHtml(task.title)}</h3>
          ${task.description ? `<p class="task-description">${escapeHtml(task.description)}</p>` : ''}
          ${tagsHtml}
          <div class="task-footer">
            <div class="task-actions" onclick="event.stopPropagation()">
              ${task.completionSummary ? `<button class="icon-btn" style="background: var(--accent-green); color: white;" title="View Results" onclick="showTaskDetail('${task.id}')">üìä</button>` : ''}
              <button class="icon-btn" title="Edit" onclick="editTask('${task.id}')">‚úèÔ∏è</button>
              <button class="icon-btn" title="Delete" onclick="confirmDeleteTask('${task.id}')">üóëÔ∏è</button>
            </div>
          </div>
          ${filesHtml}
        </div>
      `;
    }

    function renderTasks() {
      const columns = {
        backlog: document.getElementById('tasks-backlog'),
        today: document.getElementById('tasks-today'),
        tomorrow: document.getElementById('tasks-tomorrow')
      };
      
      const counts = { backlog: 0, today: 0, tomorrow: 0 };
      
      // Clear all columns
      Object.values(columns).forEach(col => col.innerHTML = '');
      
      // Filter tasks (exclude done/archived tasks - they go to reports)
      let filteredTasks = tasks.filter(t => t.status !== 'done');
      if (currentFilter !== 'all') {
        filteredTasks = filteredTasks.filter(t => t.priority === currentFilter);
      }
      
      // Add tasks to columns
      filteredTasks.forEach(task => {
        const column = columns[task.status];
        if (column) {
          column.insertAdjacentHTML('beforeend', renderTaskCard(task));
          counts[task.status]++;
        }
      });
      
      // Add empty state if no tasks
      Object.entries(columns).forEach(([status, column]) => {
        if (!column.children.length) {
          column.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìã</div>
              <p>No ${status} tasks</p>
            </div>
          `;
        }
      });
      
      // Update counts
      Object.entries(counts).forEach(([status, count]) => {
        document.getElementById(`count-${status}`).textContent = count;
      });
    }

    async function loadTasks() {
      tasks = await fetchTasks();
      renderTasks();
      initSortable(); // Re-init sortable after rendering tasks
    }

    async function refreshTasks() {
      document.getElementById('syncIndicator').classList.add('syncing');
      document.getElementById('syncStatusText').textContent = 'Syncing...';
      
      await loadTasks();
      await loadSuggestion();
      
      document.getElementById('syncIndicator').classList.remove('syncing');
      document.getElementById('syncStatusText').textContent = 'Synced';
    }

    async function loadSuggestion() {
      const content = document.getElementById('suggestionContent');
      const suggestion = await getSuggestion();
      
      if (!suggestion || !suggestion.task) {
        content.innerHTML = '<p class="empty-state">No suggestions available. Add some tasks to get recommendations!</p>';
        return;
      }
      
      const { task, score, reasoning } = suggestion;
      const priorityClass = `priority-${task.priority.toLowerCase()}`;
      
      content.innerHTML = `
        <div class="suggestion-card">
          <div class="suggestion-score">Score: ${score}% match</div>
          <h3 class="suggestion-title">${escapeHtml(task.title)}</h3>
          <p class="suggestion-reasoning">${reasoning}</p>
          <button class="btn btn-primary btn-small" onclick="startSuggestedTask('${task.id}')">Start This Task</button>
        </div>
      `;
    }

    function startSuggestedTask(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (task && task.status !== 'done') {
        moveTask(taskId, 'today').then(() => refreshTasks());
      }
    }

    // ============================================
    // MODAL FUNCTIONS
    // ============================================
    function openNewTaskModal(defaultStatus = null) {
      document.getElementById('modalTitle').textContent = 'New Task';
      document.getElementById('taskForm').reset();
      document.getElementById('taskId').value = '';
      document.getElementById('deleteBtn').style.display = 'none';
      
      // Set default priority
      document.querySelectorAll('.priority-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.priority === 'P2');
      });
      document.getElementById('taskPriority').value = 'P2';
      
      // Set default status if provided
      if (defaultStatus) {
        document.getElementById('taskStatus').value = defaultStatus;
      } else {
        document.getElementById('taskStatus').value = 'backlog';
      }
      
      document.getElementById('taskModal').classList.add('active');
    }

    function closeTaskModal() {
      document.getElementById('taskModal').classList.remove('active');
    }

    function showTaskDetail(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      
      currentDetailTask = task;
      
      const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleString() : 'Not set';
      const createdDate = new Date(task.created).toLocaleString();
      const updatedDate = new Date(task.updated).toLocaleString();
      const completedDate = task.completed ? new Date(task.completed).toLocaleString() : 'Not completed';
      
      document.getElementById('detailTitle').textContent = task.title;
      document.getElementById('detailContent').innerHTML = `
        <div class="detail-section">
          <h3>Status & Priority</h3>
          <div class="detail-row">
            <span class="status-badge ${task.status}">${task.status}</span>
            <span class="priority-badge priority-${task.priority.toLowerCase()}">${task.priority}</span>
          </div>
        </div>
        
        <div class="detail-section">
          <h3>Description</h3>
          <p>${task.description || 'No description provided.'}</p>
        </div>
        
        <div class="detail-section">
          <h3>Tags</h3>
          <div class="task-tags">
            ${task.tags && task.tags.length ? task.tags.map(t => `<span class="tag">${t}</span>`).join('') : 'No tags'}
          </div>
        </div>
        
        <div class="detail-section">
          <h3>Dates</h3>
          <p><strong>Due:</strong> ${dueDate}</p>
          <p><strong>Created:</strong> ${createdDate}</p>
          <p><strong>Updated:</strong> ${updatedDate}</p>
          <p><strong>Completed:</strong> ${completedDate}</p>
        </div>
        
        ${task.estimatedMinutes ? `
          <div class="detail-section">
            <h3>Time Estimate</h3>
            <p>${Math.round(task.estimatedMinutes / 60)} hours (${task.estimatedMinutes} minutes)</p>
          </div>
        ` : ''}
        
        ${task.sourceContext ? `
          <div class="detail-section">
            <h3>Source</h3>
            <p>${task.sourceContext}</p>
          </div>
        ` : ''}
        
        ${task.completionSummary ? `
          <div class="detail-section" style="background: rgba(76, 175, 80, 0.15); border-radius: 12px; padding: 20px; border: 1px solid rgba(76, 175, 80, 0.3);">
            <h3 style="color: #4caf50; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
              ‚úÖ Agent Execution Complete
            </h3>
            
            <!-- Cost and Duration Summary -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
              <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Duration</div>
                <div style="font-size: 18px; font-weight: bold; color: var(--accent-blue);">${task.completionSummary.durationMinutes} min</div>
              </div>
              <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Cost</div>
                <div style="font-size: 18px; font-weight: bold; color: var(--accent-green);">$${(task.completionSummary.cost || 0).toFixed(3)}</div>
              </div>
              <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Steps</div>
                <div style="font-size: 18px; font-weight: bold; color: var(--accent-orange);">${task.completionSummary.stepsCompleted}/${task.completionSummary.totalSteps}</div>
              </div>
            </div>
            
            ${task.completionSummary.urls && task.completionSummary.urls.length > 0 ? `
              <div style="margin-bottom: 16px; background: rgba(74, 144, 217, 0.2); padding: 16px; border-radius: 8px;">
                <strong style="color: var(--accent-blue);">üîó URLs Created:</strong>
                <ul style="margin: 8px 0 0 0; padding-left: 0; list-style: none;">
                  ${task.completionSummary.urls.map(url => `
                    <li style="margin: 6px 0; display: flex; align-items: center; gap: 8px;">
                      <a href="${escapeHtml(url)}" target="_blank" style="color: var(--accent-blue); text-decoration: underline; font-size: 13px; word-break: break-all; flex: 1;">
                        ${escapeHtml(url)}
                      </a>
                      <button class="btn btn-small btn-secondary" style="padding: 4px 12px; font-size: 10px;"
                              onclick="navigator.clipboard.writeText('${escapeHtml(url)}'); showToast('URL copied!', 'success');">Copy</button>
                    </li>
                  `).join('')}
                </ul>
              </div>
            ` : ''}
            
            <!-- Output Files -->
            ${task.completionSummary.outputFiles && task.completionSummary.outputFiles.length > 0 && !task.completionSummary.outputFiles.includes('No files generated') ? `
              <div style="margin-bottom: 16px; background: rgba(255, 152, 0, 0.15); padding: 16px; border-radius: 8px; border: 1px solid rgba(255, 152, 0, 0.3);">
                <strong style="color: var(--accent-orange);">üìÅ Output Files:</strong>
                <ul style="margin: 10px 0 0 0; padding-left: 0; list-style: none;">
                  ${task.completionSummary.outputFiles.map(file => `
                    <li style="margin: 6px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                      <span style="font-size: 16px;">üìÑ</span>
                      <code style="flex: 1; font-size: 12px; color: var(--text-primary);">${escapeHtml(file)}</code>
                      <button class="btn btn-small btn-secondary" style="padding: 4px 12px; font-size: 10px;"
                              onclick="navigator.clipboard.writeText('${escapeHtml(file)}'); showToast('Path copied!', 'success');">Copy</button>
                    </li>
                  `).join('')}
                </ul>
                <div style="margin-top: 12px; padding: 10px; background: rgba(74, 144, 217, 0.1); border-radius: 6px;">
                  <strong style="font-size: 11px; color: var(--text-secondary);">üìÇ Finder Location:</strong>
                  <code style="display: block; margin-top: 6px; font-size: 11px; color: var(--accent-blue); cursor: pointer;" 
                        onclick="navigator.clipboard.writeText('${task.completionSummary.finderPath}'); showToast('Path copied!', 'success');">
                    ${task.completionSummary.finderPath} <span style="margin-left: 4px;">üìã</span>
                  </code>
                </div>
              </div>
            ` : ''}
            
            <!-- What Was Accomplished -->
            <div style="margin-bottom: 16px;">
              <strong style="color: var(--text-primary);">üìù What Was Accomplished:</strong>
              <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; margin-top: 10px; font-size: 13px; line-height: 1.6; white-space: pre-wrap;">${escapeHtml(task.completionSummary.whatWasAccomplished)}</div>
            </div>
            
            <!-- Footer Info -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: var(--text-secondary);">
              <span>Completed: ${new Date(task.completionSummary.completedAt).toLocaleString()}</span>
              <span>Task ID: ${task.completionSummary.taskId.substring(0, 8)}...</span>
            </div>
          </div>
        ` : ''}
      `;
      
      document.getElementById('detailModal').classList.add('active');
    }

    function closeDetailModal() {
      document.getElementById('detailModal').classList.remove('active');
    }

    function editTask(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      
      document.getElementById('modalTitle').textContent = 'Edit Task';
      document.getElementById('taskId').value = task.id;
      document.getElementById('taskTitle').value = task.title;
      document.getElementById('taskDescription').value = task.description || '';
      document.getElementById('taskStatus').value = task.status;
      document.getElementById('taskPriority').value = task.priority;
      document.getElementById('taskDueDate').value = task.dueDate ? task.dueDate.split('T')[0] : '';
      document.getElementById('taskTags').value = (task.tags || []).join(', ');
      
      // Agent settings (new fields)
      document.getElementById('taskAgentType').value = task.agentType || 'auto';
      document.getElementById('taskPlanFirst').checked = task.planFirst === true;
      
      // Update priority selector
      document.querySelectorAll('.priority-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.priority === task.priority);
      });
      
      document.getElementById('deleteBtn').style.display = 'block';
      document.getElementById('taskModal').classList.add('active');
    }

    function editFromDetail() {
      if (currentDetailTask) {
        editTask(currentDetailTask.id);
      }
    }

    async function handleTaskSubmit(event) {
      event.preventDefault();
      
      const taskId = document.getElementById('taskId').value;
      const taskData = {
        title: document.getElementById('taskTitle').value.trim(),
        description: document.getElementById('taskDescription').value.trim() || null,
        priority: document.getElementById('taskPriority').value,
        status: document.getElementById('taskStatus').value,
        dueDate: document.getElementById('taskDueDate').value 
          ? new Date(document.getElementById('taskDueDate').value).toISOString() 
          : null,
        tags: document.getElementById('taskTags').value
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0),
        agentType: document.getElementById('taskAgentType').value,
        planFirst: document.getElementById('taskPlanFirst').checked
      };
      
      try {
        if (taskId) {
          // Update existing task
          await updateTask(taskId, taskData);
        } else {
          // Create new task
          await createTask(taskData);
        }
        
        closeTaskModal();
        await refreshTasks();
      } catch (err) {
        console.error('Error saving task:', err);
      }
    }

    async function confirmDeleteTask(taskId) {
      if (confirm('Are you sure you want to delete this task?')) {
        await deleteTaskById(taskId);
        closeTaskModal();
        await refreshTasks();
      }
    }

    function deleteTask() {
      const taskId = document.getElementById('taskId').value;
      if (taskId) {
        confirmDeleteTask(taskId);
      }
    }

    // ============================================
    // DRAG AND DROP
    // ============================================
    let sortableInstances = [];
    
    function initSortable() {
      // Destroy existing instances first
      sortableInstances.forEach(s => s.destroy());
      sortableInstances = [];
      
      const columns = document.querySelectorAll('.task-list');
      
      columns.forEach(column => {
        const sortable = new Sortable(column, {
          group: 'tasks',
          animation: 150,
          ghostClass: 'sortable-ghost',
          chosenClass: 'sortable-chosen',
          delay: 100,
          delayOnTouchOnly: true,
          preventOnFilter: false,
          filter: '.empty-state, .task-controls, button, .icon-btn',
          onStart: function(evt) {
            // Don't trigger card click when dragging
            evt.item.onclick = null;
          },
          onEnd: async function(evt) {
            const taskId = evt.item.dataset.taskId;
            const newStatus = evt.to.dataset.status;
            const task = tasks.find(t => t.id === taskId);
            
            // Restore click handler
            evt.item.onclick = function() { editTask(taskId); };
            
            if (task && task.status !== newStatus) {
              task.status = newStatus;
              await moveTask(taskId, newStatus);
              await refreshTasks();
            }
          }
        });
        sortableInstances.push(sortable);
      });
    }

    // ============================================
    // FILTER & SEARCH
    // ============================================
    function initFilters() {
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          currentFilter = chip.dataset.filter;
          renderTasks();
        });
      });
    }

    function initSearch() {
      const searchInput = document.getElementById('searchInput');
      let searchTimeout;
      
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
          const query = searchInput.value.trim();
          if (query.length > 0) {
            tasks = await fetchTasks({ search: query });
          } else {
            tasks = await fetchTasks();
          }
          renderTasks();
        }, 300);
      });
    }

    // ============================================
    // PRIORITY SELECTOR
    // ============================================
    function initPrioritySelector() {
      document.querySelectorAll('.priority-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          document.getElementById('taskPriority').value = option.dataset.priority;
        });
      });
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${message}</span>`;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ============================================
    // KEYBOARD SHORTCUTS
    // ============================================
    function initKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Ignore if typing in input field
        if (e.target.matches('input, textarea')) {
          if (e.key === 'Escape') {
            closeTaskModal();
            closeDetailModal();
          }
          return;
        }
        
        switch(e.key.toLowerCase()) {
          case 'n':
            e.preventDefault();
            openNewTaskModal();
            break;
          case 'f':
            e.preventDefault();
            document.getElementById('searchInput').focus();
            break;
          case 'escape':
            closeTaskModal();
            closeDetailModal();
            break;
          case 'r':
            if (!e.ctrlKey && !e.metaKey) {
              e.preventDefault();
              refreshTasks();
            }
            break;
        }
      });
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    async function init() {
      await loadTasks();
      await loadSuggestion();
      initSortable();
      initFilters();
      initSearch();
      initPrioritySelector();
      initKeyboardShortcuts();
      
      // Auto-refresh every 30 seconds
      setInterval(async () => {
        await refreshTasks();
      }, 30000);
      
      // Periodic Obsidian sync every 60 seconds
      setInterval(async () => {
        await syncObsidian();
      }, 60000);
      
      // Close modals on overlay click
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('active');
          }
        });
      });
      
      console.log('üöÄ Kanban Board initialized');
    }

    init();
// ============================================
// FILE MANAGEMENT FUNCTIONS
// ============================================

let currentFileTaskId = null;

async function openFileManager(taskId = null) {
  const modal = document.getElementById('fileModal');
  const taskSelector = document.getElementById('fileTaskSelector');
  const taskSelect = document.getElementById('fileTaskSelect');
  
  // Populate task selector if multiple tasks exist
  if (tasks.length > 1) {
    taskSelector.style.display = 'block';
    taskSelect.innerHTML = '<option value="">Select a task...</option>';
    tasks.forEach(task => {
      const option = document.createElement('option');
      option.value = task.id;
      option.textContent = task.title.substring(0, 50);
      if (task.id === taskId || task.id === currentDetailTask?.id) {
        option.selected = true;
      }
      taskSelect.appendChild(option);
    });
  }
  
  currentFileTaskId = taskId || currentDetailTask?.id || taskSelect.value;
  
  if (currentFileTaskId) {
    taskSelect.value = currentFileTaskId;
    await loadTaskFiles();
  } else {
    document.getElementById('fileList').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Select a task to view its files</p>';
  }
  
  modal.classList.add('active');
}

function closeFileModal() {
  document.getElementById('fileModal').classList.remove('active');
  document.getElementById('uploadProgress').style.display = 'none';
  document.getElementById('fileList').innerHTML = '';
}

async function loadTaskFiles() {
  const taskId = document.getElementById('fileTaskSelect').value;
  currentFileTaskId = taskId;
  
  const fileList = document.getElementById('fileList');
  
  if (!taskId) {
    fileList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Select a task to view its files</p>';
    return;
  }
  
  try {
    const response = await fetch(`${API_BASE}/files?taskId=${taskId}`);
    const data = await response.json();
    
    if (data.files.length === 0) {
      fileList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No files attached to this task</p>';
      return;
    }
    
    fileList.innerHTML = data.files.map(file => renderFileItem(file)).join('');
  } catch (err) {
    console.error('Error loading files:', err);
    fileList.innerHTML = '<p style="color: var(--accent-red);">Failed to load files</p>';
  }
}

function renderFileItem(file) {
  const isImage = file.mimetype.startsWith('image/');
  const size = formatFileSize(file.size);
  const date = new Date(file.uploaded).toLocaleDateString();
  
  if (isImage && file.thumbnail) {
    return `
      <div class="file-item" data-file-id="${file.id}">
        <img src="/thumbnails/${file.id}.jpg" class="file-thumbnail" alt="${escapeHtml(file.filename)}" 
             onerror="this.outerHTML='<div class=\\'file-icon\\'>üìÑ</div>'">
        <div class="file-info">
          <div class="file-name">${escapeHtml(file.filename)}</div>
          <div class="file-meta">${size} ‚Ä¢ ${date}</div>
        </div>
        <div class="file-actions">
          <button class="icon-btn" title="View" onclick="viewFile('${file.id}')">üëÅÔ∏è</button>
          <button class="icon-btn" title="Download" onclick="downloadFile('${file.id}')">‚¨áÔ∏è</button>
          <button class="icon-btn" title="Remove" onclick="removeFileFromTask('${file.id}')">‚ùå</button>
        </div>
      </div>
    `;
  }
  
  const icon = getFileIcon(file.filename);
  return `
    <div class="file-item" data-file-id="${file.id}">
      <div class="file-icon">${icon}</div>
      <div class="file-info">
        <div class="file-name">${escapeHtml(file.filename)}</div>
        <div class="file-meta">${size} ‚Ä¢ ${date}</div>
      </div>
      <div class="file-actions">
        <button class="icon-btn" title="View" onclick="viewFile('${file.id}')">üëÅÔ∏è</button>
        <button class="icon-btn" title="Download" onclick="downloadFile('${file.id}')">‚¨áÔ∏è</button>
        <button class="icon-btn" title="Remove" onclick="removeFileFromTask('${file.id}')">‚ùå</button>
      </div>
    </div>
  `;
}

function getFileIcon(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  const icons = {
    'png': 'üñºÔ∏è', 'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'gif': 'üñºÔ∏è', 'webp': 'üñºÔ∏è',
    'pdf': 'üìï', 'doc': 'üìò', 'docx': 'üìò',
    'xls': 'üìó', 'xlsx': 'üìó',
    'ppt': 'üìô', 'pptx': 'üìô',
    'txt': 'üìÑ', 'md': 'üìù', 'json': 'üìã',
    'js': 'üíª', 'ts': 'üíª', 'py': 'üêç', 'html': 'üåê', 'css': 'üé®',
    'sh': '‚öôÔ∏è', 'zsh': '‚öôÔ∏è',
    'zip': 'üì¶', 'tar': 'üì¶', 'gz': 'üì¶', '7z': 'üì¶'
  };
  return icons[ext] || 'üìÑ';
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function viewFile(fileId) {
  window.open(`${API_BASE}/files/${fileId}/view`, '_blank');
}

function downloadFile(fileId) {
  const link = document.createElement('a');
  link.href = `${API_BASE}/files/${fileId}/view`;
  link.download = '';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

async function removeFileFromTask(fileId) {
  if (!confirm('Remove this file from the task? The file will still be stored.')) return;
  
  try {
    await fetch(`${API_BASE}/files/${fileId}`, { method: 'DELETE' });
    showToast('File removed from task', 'success');
    await loadTaskFiles();
    await refreshTasks();
  } catch (err) {
    console.error('Error removing file:', err);
    showToast('Failed to remove file', 'error');
  }
}

// File upload handlers
function handleDragOver(e) {
  e.preventDefault();
  e.stopPropagation();
  document.getElementById('fileUploadArea').classList.add('dragover');
}

function handleDragLeave(e) {
  e.preventDefault();
  e.stopPropagation();
  document.getElementById('fileUploadArea').classList.remove('dragover');
}

async function handleDrop(e) {
  e.preventDefault();
  e.stopPropagation();
  document.getElementById('fileUploadArea').classList.remove('dragover');
  
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    await uploadFiles(files);
  }
}

function handleFileSelect(e) {
  const files = e.target.files;
  if (files.length > 0) {
    uploadFiles(files);
  }
}

async function uploadFiles(fileList) {
  const taskId = document.getElementById('fileTaskSelect').value || currentFileTaskId;
  const progressDiv = document.getElementById('uploadProgress');
  const progressBar = document.getElementById('progressBar');
  const uploadStatus = document.getElementById('uploadStatus');
  
  progressDiv.style.display = 'block';
  
  for (let i = 0; i < fileList.length; i++) {
    const file = fileList[i];
    uploadStatus.textContent = `Uploading ${i + 1}/${fileList.length}: ${file.name}`;
    progressBar.style.width = `${((i + 1) / fileList.length) * 100}%`;
    
    try {
      const formData = new FormData();
      formData.append('file', file);
      if (taskId) formData.append('taskId', taskId);
      
      const response = await fetch(`${API_BASE}/files/upload`, {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) throw new Error('Upload failed');
      
      const result = await response.json();
      console.log('Uploaded:', result.file.filename);
    } catch (err) {
      console.error('Error uploading file:', file.name, err);
      showToast(`Failed to upload: ${file.name}`, 'error');
    }
  }
  
  showToast(`${fileList.length} file(s) uploaded`, 'success');
  
  setTimeout(() => {
    progressDiv.style.display = 'none';
    progressBar.style.width = '0%';
    loadTaskFiles();
    refreshTasks();
  }, 1000);
}

// ============================================
// KEYBOARD SHORTCUTS MODAL
// ============================================

function showKeyboardShortcuts() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.id = 'shortcutsModal';
  modal.innerHTML = `
    <div class="modal" style="max-width: 550px;">
      <div class="modal-header">
        <h2>‚å®Ô∏è Keyboard Shortcuts</h2>
        <button class="modal-close" onclick="document.getElementById('shortcutsModal').remove()">√ó</button>
      </div>
      <div style="padding: 8px 0;">
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
          <tr style="border-bottom: 1px solid var(--border-color);">
            <td style="padding: 12px 8px;"><kbd style="background: var(--bg-tertiary); padding: 4px 10px; border-radius: 4px; font-family: monospace;">N</kbd></td>
            <td style="padding: 12px 8px;">Create new task</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border-color);">
            <td style="padding: 12px 8px;"><kbd style="background: var(--bg-tertiary); padding: 4px 10px; border-radius: 4px; font-family: monospace;">F</kbd></td>
            <td style="padding: 12px 8px;">Focus search bar</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border-color);">
            <td style="padding: 12px 8px;"><kbd style="background: var(--bg-tertiary); padding: 4px 10px; border-radius: 4px; font-family: monospace;">/</kbd></td>
            <td style="padding: 12px 8px;">Open command palette</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border-color);">
            <td style="padding: 12px 8px;"><kbd style="background: var(--bg-tertiary); padding: 4px 10px; border-radius: 4px; font-family: monospace;">R</kbd></td>
            <td style="padding: 12px 8px;">Refresh all data</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border-color);">
            <td style="padding: 12px 8px;"><kbd style="background: var(--bg-tertiary); padding: 4px 10px; border-radius: 4px; font-family: monospace;">Esc</kbd></td>
            <td style="padding: 12px 8px;">Close modal / Clear filter</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--border-color);">
            <td style="padding: 12px 8px;"><kbd style="background: var(--bg-tertiary); padding: 4px 10px; border-radius: 4px; font-family: monospace;">Ctrl+S</kbd></td>
            <td style="padding: 12px 8px;">Force sync to Obsidian</td>
          </tr>
          <tr>
            <td style="padding: 12px 8px;"><kbd style="background: var(--bg-tertiary); padding: 4px 10px; border-radius: 4px; font-family: monospace;">Drag</kbd></td>
            <td style="padding: 12px 8px;">Move task between columns</td>
          </tr>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('shortcutsModal').remove()">Close</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.remove();
  });
}

// ============================================
// DATAVIEWJS QUERIES MODAL
// ============================================

async function showDataviewQueries() {
  try {
    const response = await fetch(`${API_BASE}/sync/dataview`);
    const data = await response.json();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'dataviewModal';
    modal.innerHTML = `
      <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
          <h2>üìä DataviewJS Queries for Obsidian</h2>
          <button class="modal-close" onclick="document.getElementById('dataviewModal').remove()">√ó</button>
        </div>
        <div style="max-height: 60vh; overflow-y: auto; padding: 8px 0;">
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">üìã All Active Tasks</h3>
            <pre style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; font-size: 12px; overflow-x: auto; white-space: pre-wrap;">${escapeHtml(data.dataviewQueries.allTasks)}</pre>
          </div>
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">üìÖ Today's Tasks</h3>
            <pre style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; font-size: 12px; overflow-x: auto; white-space: pre-wrap;">${escapeHtml(data.dataviewQueries.todayTasks)}</pre>
          </div>
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">‚ö†Ô∏è Overdue Tasks</h3>
            <pre style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; font-size: 12px; overflow-x: auto; white-space: pre-wrap;">${escapeHtml(data.dataviewQueries.overdueTasks)}</pre>
          </div>
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">üìà By Priority</h3>
            <pre style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; font-size: 12px; overflow-x: auto; white-space: pre-wrap;">${escapeHtml(data.dataviewQueries.byPriority)}</pre>
          </div>
          <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-top: 16px;">
            <h3 style="font-size: 14px; margin-bottom: 12px;">üìä Quick Stats</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
              <div>
                <div style="font-size: 24px; font-weight: 600; color: var(--accent-blue);">${data.statistics.active}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">Active Tasks</div>
              </div>
              <div>
                <div style="font-size: 24px; font-weight: 600; color: var(--accent-green);">${data.statistics.completed}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">Completed</div>
              </div>
              <div>
                <div style="font-size: 24px; font-weight: 600; color: var(--accent-red);">${data.statistics.overdue}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">Overdue</div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="document.getElementById('dataviewModal').remove()">Close</button>
          <button class="btn btn-primary" onclick="copyAllDataviewQueries()">üìã Copy All</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
  } catch (err) {
    console.error('Error loading Dataview queries:', err);
    showToast('Failed to load Dataview queries', 'error');
  }
}

function copyAllDataviewQueries() {
  const queries = `<!-- Kanban DataviewJS Queries -->
<!-- Copy these to your Obsidian notes -->

## All Active Tasks
\`\`\`dataview
TABLE priority, status, dueDate
FROM "Tasks"
WHERE status != "deleted"
SORT priority ASC, dueDate ASC
\`\`\`

## Today's Tasks
\`\`\`dataview
TABLE priority, dueDate, tags
FROM "Tasks/today"
SORT priority ASC
\`\`\`

## Overdue Tasks
\`\`\`dataview
TABLE priority, dueDate, daysOverdue
FROM "Tasks"
WHERE dueDate < date(today) AND status != "done"
SORT priority ASC
\`\`\`

## By Priority
\`\`\`dataview
TABLE status, length(rows) as count
FROM "Tasks"
WHERE status != "done"
GROUP BY priority
\`\`\``;
  
  navigator.clipboard.writeText(queries).then(() => {
    showToast('DataviewJS queries copied to clipboard', 'success');
  });
}

// ============================================
// COMMAND PALETTE
// ============================================

function openCommandPalette() {
  const commands = [
    { id: 'new-task', title: 'Create new task', shortcut: 'N', action: () => openNewTaskModal() },
    { id: 'search', title: 'Search tasks', shortcut: 'F', action: () => document.getElementById('searchInput').focus() },
    { id: 'refresh', title: 'Refresh all data', shortcut: 'R', action: () => refreshTasks() },
    { id: 'sync', title: 'Sync with Obsidian', shortcut: 'Ctrl+S', action: () => syncObsidian() },
    { id: 'suggestion', title: 'Get task suggestion', shortcut: '/', action: () => loadSuggestion() },
    { id: 'today', title: 'Filter: Today\'s tasks', shortcut: 'T', action: () => filterByStatus('today') },
    { id: 'backlog', title: 'Filter: Backlog', shortcut: 'B', action: () => filterByStatus('backlog') },
    { id: 'done', title: 'Filter: Done', shortcut: 'D', action: () => filterByStatus('done') },
    { id: 'shortcuts', title: 'Show keyboard shortcuts', shortcut: '?', action: () => showKeyboardShortcuts() },
    { id: 'dataview', title: 'Show DataviewJS queries', shortcut: '', action: () => showDataviewQueries() },
    { id: 'sync-status', title: 'Show sync status', shortcut: '', action: () => showSyncStatus() }
  ];
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.id = 'commandPalette';
  modal.innerHTML = `
    <div class="modal" style="max-width: 500px; padding: 0; overflow: hidden;">
      <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-color);">
        <input type="text" id="commandInput" placeholder="Type a command..." 
               style="width: 100%; background: transparent; border: none; color: var(--text-primary); font-size: 16px; outline: none;">
      </div>
      <div id="commandList" style="max-height: 400px; overflow-y: auto; padding: 8px;"></div>
      <div style="padding: 12px 20px; border-top: 1px solid var(--border-color); font-size: 11px; color: var(--text-secondary);">
        Use ‚Üë‚Üì to navigate, Enter to select, Esc to close
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  const commandList = document.getElementById('commandList');
  const commandInput = document.getElementById('commandInput');
  let selectedIndex = 0;
  
  function renderCommands(filter = '') {
    const filtered = commands.filter(cmd => 
      cmd.title.toLowerCase().includes(filter.toLowerCase()) ||
      cmd.shortcut.toLowerCase().includes(filter.toLowerCase())
    );
    
    commandList.innerHTML = filtered.map((cmd, index) => `
      <div class="command-item ${index === selectedIndex ? 'selected' : ''}" 
           data-index="${index}" style="padding: 12px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; ${index === selectedIndex ? 'background: rgba(74, 144, 217, 0.2);' : ''}">
        <span>${cmd.title}</span>
        ${cmd.shortcut ? `<kbd style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px; font-size: 11px;">${cmd.shortcut}</kbd>` : ''}
      </div>
    `).join('');
    
    // Add click handlers
    commandList.querySelectorAll('.command-item').forEach(item => {
      item.onclick = () => {
        const idx = parseInt(item.dataset.index);
        filtered[idx]?.action();
        modal.remove();
      };
    });
  }
  
  renderCommands();
  
  commandInput.focus();
  
  commandInput.oninput = () => {
    renderCommands(commandInput.value);
  };
  
  commandInput.onkeydown = (e) => {
    const filtered = commands.filter(cmd => 
      cmd.title.toLowerCase().includes(commandInput.value.toLowerCase())
    );
    
    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        selectedIndex = (selectedIndex + 1) % filtered.length;
        renderCommands(commandInput.value);
        break;
      case 'ArrowUp':
        e.preventDefault();
        selectedIndex = (selectedIndex - 1 + filtered.length) % filtered.length;
        renderCommands(commandInput.value);
        break;
      case 'Enter':
        e.preventDefault();
        filtered[selectedIndex]?.action();
        modal.remove();
        break;
      case 'Escape':
        modal.remove();
        break;
    }
  };
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.remove();
  });
}

function filterByStatus(status) {
  // Reset filter chips
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  document.querySelector('.filter-chip[data-filter="all"]')?.classList.add('active');
  currentFilter = 'all';
  
  // Fetch tasks by status
  fetchTasks({ status }).then(filteredTasks => {
    tasks = filteredTasks;
    renderTasks();
  });
}

// ============================================
// THEME TOGGLE
// ============================================

let isDarkMode = true;

function toggleTheme() {
  isDarkMode = !isDarkMode;
  document.documentElement.style.setProperty('--bg-primary', isDarkMode ? '#1a1a2e' : '#f5f5f5');
  document.documentElement.style.setProperty('--bg-secondary', isDarkMode ? '#16213e' : '#ffffff');
  document.documentElement.style.setProperty('--bg-tertiary', isDarkMode ? '#0f0f23' : '#e0e0e0');
  document.documentElement.style.setProperty('--text-primary', isDarkMode ? '#eaeaea' : '#1a1a1a');
  document.documentElement.style.setProperty('--text-secondary', isDarkMode ? '#a0a0a0' : '#666666');
  document.documentElement.style.setProperty('--border-color', isDarkMode ? '#2a2a4a' : '#dddddd');
  
  // Save preference
  localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
  showToast(`Switched to ${isDarkMode ? 'dark' : 'light'} mode`, 'info');
}

function initTheme() {
  const saved = localStorage.getItem('theme');
  if (saved === 'light') {
    isDarkMode = false;
    document.documentElement.style.setProperty('--bg-primary', '#f5f5f5');
    document.documentElement.style.setProperty('--bg-secondary', '#ffffff');
    document.documentElement.style.setProperty('--bg-tertiary', '#e0e0e0');
    document.documentElement.style.setProperty('--text-primary', '#1a1a1a');
    document.documentElement.style.setProperty('--text-secondary', '#666666');
    document.documentElement.style.setProperty('--border-color', '#dddddd');
  }
}

// ============================================
// UNDO/REDO FUNCTIONALITY
// ============================================

const actionHistory = [];
const MAX_HISTORY = 50;

function pushAction(action) {
  actionHistory.push(action);
  if (actionHistory.length > MAX_HISTORY) {
    actionHistory.shift();
  }
}

function undoLastAction() {
  if (actionHistory.length === 0) {
    showToast('Nothing to undo', 'info');
    return;
  }
  
  const lastAction = actionHistory.pop();
  // Implement undo logic based on action type
  showToast('Undo: ' + lastAction.description, 'info');
}

// ============================================
// BULK OPERATIONS
// ============================================

let selectedTasks = new Set();

function toggleTaskSelection(taskId) {
  if (selectedTasks.has(taskId)) {
    selectedTasks.delete(taskId);
  } else {
    selectedTasks.add(taskId);
  }
  updateBulkActionsUI();
}

function updateBulkActionsUI() {
  const count = selectedTasks.size;
  // Update UI to show selected count and available bulk actions
  if (count > 0) {
    showToast(`${count} task${count > 1 ? 's' : ''} selected`, 'info');
  }
}

async function bulkMoveTasks(newStatus) {
  if (selectedTasks.size === 0) return;
  
  for (const taskId of selectedTasks) {
    await moveTask(taskId, newStatus);
  }
  
  const count = selectedTasks.size;
  selectedTasks.clear();
  showToast(`Moved ${count} tasks to ${newStatus}`, 'success');
  await refreshTasks();
}

async function bulkDeleteTasks() {
  if (selectedTasks.size === 0) return;
  
  if (!confirm(`Delete ${selectedTasks.size} tasks? This cannot be undone.`)) return;
  
  for (const taskId of selectedTasks) {
    await deleteTaskById(taskId);
  }
  
  const count = selectedTasks.size;
  selectedTasks.clear();
  showToast(`Deleted ${count} tasks`, 'success');
  await refreshTasks();
}

// ============================================
// WEBSOCKET CONNECTION FOR REAL-TIME UPDATES
// ============================================

let ws = null;
let wsReconnectAttempts = 0;
const WS_MAX_RECONNECT_ATTEMPTS = 5;
const WS_RECONNECT_DELAY = 3000;

function initWebSocket() {
  const wsUrl = `ws://${window.location.host}`;
  
  try {
    ws = new WebSocket(wsUrl);
    
    ws.onopen = () => {
      console.log('üì° WebSocket connected');
      wsReconnectAttempts = 0;
      showToast('Real-time sync active', 'success');
    };
    
    ws.onmessage = (event) => {
      try {
        const message = JSON.parse(event.data);
        handleWebSocketMessage(message);
      } catch (err) {
        console.error('Error parsing WebSocket message:', err);
      }
    };
    
    ws.onclose = () => {
      console.log('üì° WebSocket disconnected');
      ws = null;
      
      // Attempt reconnection
      if (wsReconnectAttempts < WS_MAX_RECONNECT_ATTEMPTS) {
        wsReconnectAttempts++;
        console.log(`Attempting to reconnect (${wsReconnectAttempts}/${WS_MAX_RECONNECT_ATTEMPTS})...`);
        setTimeout(initWebSocket, WS_RECONNECT_DELAY);
      }
    };
    
    ws.onerror = (err) => {
      console.error('WebSocket error:', err);
    };
  } catch (err) {
    console.error('Failed to initialize WebSocket:', err);
  }
}

function handleWebSocketMessage(message) {
  switch (message.type) {
    case 'tasks-refreshed':
      console.log('üì° Tasks refreshed from Obsidian');
      refreshTasks();
      if (message.data?.changes) {
        const { created, updated, deleted } = message.data.changes;
        if (created || updated || deleted) {
          const changes = [];
          if (created) changes.push(`${created} created`);
          if (updated) changes.push(`${updated} updated`);
          if (deleted) changes.push(`${deleted} deleted`);
          showToast(`Synced from Obsidian: ${changes.join(', ')}`, 'info');
        }
      }
      break;
      
    case 'task-pushed':
      console.log(`üì° Task ${message.data.taskId} pushed to Obsidian`);
      break;
      
    case 'task-deleted':
      console.log(`üì° Task ${message.data.taskId} deleted in Obsidian`);
      refreshTasks();
      break;
      
    case 'all-pushed':
      console.log(`üì° All tasks pushed to Obsidian (${message.data.count})`);
      break;
      
    case 'session-started':
      console.log(`ü§ñ Session started: ${message.data.sessionId}`);
      loadActiveSessions();
      break;
      
    case 'plan-ready':
      console.log(`üìã Plan ready for task: ${message.data.taskId}`);
      showPlanReviewModal(message.data.taskId);
      break;
      
    case 'execution-started':
      console.log(`‚ñ∂Ô∏è Execution started: ${message.data.execId}`);
      showToast('Execution started', 'success');
      loadActiveSessions();
      break;
      
    case 'execution-progress':
      // Update progress bar or status
      if (message.data.progress) {
        console.log(`üìä Progress: ${message.data.progress}%`);
      }
      break;
      
    case 'step-model-update':
      // Update model info in session card
      updateSessionModelInfo(message.data.execId, message.data.model, message.data.agent);
      break;
      
    case 'step-tokens-update':
      // Update token count in session card
      updateSessionTokenInfo(message.data.execId, message.data.tokensUsed, message.data.totalTokens);
      break;
      
    case 'execution-complete':
      console.log(`‚úÖ Execution complete: ${message.data.execId}`);
      showToast('Execution complete!', 'success');
      loadActiveSessions();
      loadSessionHistory();
      refreshTasks();
      break;
      
    case 'task-archived':
      console.log(`üì¶ Task archived: ${message.data.taskId}`);
      showToast(message.data.message || 'Task completed and archived', 'success');
      refreshTasks();
      loadReports();
      loadArchive();
      break;
      
    case 'execution-error':
      console.error(`‚ùå Execution error: ${message.data.error}`);
      showToast(`Execution failed: ${message.data.error}`, 'error');
      loadActiveSessions();
      break;
  }
}

/**
 * Update model info in a session card
 */
function updateSessionModelInfo(execId, model, agent) {
  const sessionCard = document.getElementById(`session-${execId}`);
  if (sessionCard) {
    const modelInfo = sessionCard.querySelector('.session-model-info');
    if (modelInfo) {
      modelInfo.innerHTML = `ü§ñ ${model || agent || 'Running...'}`;
    }
  }
}

/**
 * Update token info in a session card
 */
function updateSessionTokenInfo(execId, stepTokens, totalTokens) {
  const sessionCard = document.getElementById(`session-${execId}`);
  if (sessionCard) {
    const modelInfo = sessionCard.querySelector('.session-model-info');
    if (modelInfo) {
      const currentText = modelInfo.innerHTML.split('|')[0];
      modelInfo.innerHTML = `${currentText} | ${stepTokens.toLocaleString()} tokens${totalTokens ? ` <span style="margin-left: 8px; color: var(--text-secondary);">(Total: ${totalTokens.toLocaleString()})</span>` : ''}`;
    }
  }
}

// ============================================
// SYNC STATUS & CONTROL
// ============================================

async function showSyncStatus() {
  try {
    const response = await fetch(`${API_BASE}/sync/status`);
    const status = await response.json();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.innerHTML = `
      <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
          <h2>üîÑ Obsidian Sync Status</h2>
          <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
        </div>
        <div style="padding: 16px 0;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
            <span class="sync-indicator ${status.watcherActive ? '' : 'syncing'}"></span>
            <span>File Watcher: ${status.watcherActive ? 'üü¢ Active' : 'üî¥ Inactive'}</span>
          </div>
          <div style="margin-bottom: 16px;">
            <div style="font-size: 12px; color: var(--text-secondary);">Last Pull</div>
            <div>${status.lastPull ? new Date(status.lastPull).toLocaleString() : 'Never'}</div>
          </div>
          <div style="margin-bottom: 16px;">
            <div style="font-size: 12px; color: var(--text-secondary);">Last Push</div>
            <div>${status.lastPush ? new Date(status.lastPush).toLocaleString() : 'Never'}</div>
          </div>
          ${status.conflicts && status.conflicts.length > 0 ? `
            <div style="background: rgba(244, 67, 54, 0.1); border: 1px solid var(--accent-red); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
              <div style="color: var(--accent-red); margin-bottom: 8px;">‚ö†Ô∏è ${status.conflicts.length} Conflict(s) Detected</div>
              ${status.conflicts.map(c => `<div style="font-size: 12px;">${c.file}</div>`).join('')}
            </div>
          ` : ''}
          <div style="font-size: 12px; color: var(--text-secondary);">Vault: ${status.obsidianVault}</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="toggleWatcher('${status.watcherActive ? 'stop' : 'start'}')">
            ${status.watcherActive ? 'üõë Stop Watcher' : '‚ñ∂Ô∏è Start Watcher'}
          </button>
          <button class="btn btn-secondary" onclick="syncObsidian()">üîÑ Full Sync</button>
          <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  } catch (err) {
    console.error('Error loading sync status:', err);
    showToast('Failed to load sync status', 'error');
  }
}

async function toggleWatcher(action) {
  try {
    const response = await fetch(`${API_BASE}/sync/watcher/toggle`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action })
    });
    const result = await response.json();
    showToast(result.message, 'success');
    this.closest('.modal-overlay')?.remove();
  } catch (err) {
    showToast('Failed to toggle watcher', 'error');
  }
}

// Update task detail to show attached files
async function showTaskDetail(taskId) {
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  
  currentDetailTask = task;
  
  const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleString() : 'Not set';
  const createdDate = new Date(task.created).toLocaleString();
  const updatedDate = new Date(task.updated).toLocaleString();
  const completedDate = task.completed ? new Date(task.completed).toLocaleString() : 'Not completed';
  
  document.getElementById('detailTitle').textContent = task.title;
  document.getElementById('detailContent').innerHTML = `
    <div class="detail-section">
      <h3>Status & Priority</h3>
      <div class="detail-row">
        <span class="status-badge ${task.status}">${task.status}</span>
        <span class="priority-badge priority-${task.priority.toLowerCase()}">${task.priority}</span>
      </div>
    </div>
    
    <div class="detail-section">
      <h3>Description</h3>
      <p>${task.description || 'No description provided.'}</p>
    </div>
    
    <div class="detail-section">
      <h3>Tags</h3>
      <div class="task-tags">
        ${task.tags && task.tags.length ? task.tags.map(t => `<span class="tag">${t}</span>`).join('') : 'No tags'}
      </div>
    </div>
    
    <div class="detail-section">
      <h3>Dates</h3>
      <p><strong>Due:</strong> ${dueDate}</p>
      <p><strong>Created:</strong> ${createdDate}</p>
      <p><strong>Updated:</strong> ${updatedDate}</p>
      <p><strong>Completed:</strong> ${completedDate}</p>
    </div>
    
    ${task.estimatedMinutes ? `
      <div class="detail-section">
        <h3>Time Estimate</h3>
        <p>${Math.round(task.estimatedMinutes / 60)} hours (${task.estimatedMinutes} minutes)</p>
      </div>
    ` : ''}
    
    ${task.sourceContext ? `
      <div class="detail-section">
        <h3>Source</h3>
        <p>${task.sourceContext}</p>
      </div>
    ` : ''}
    
    ${task.completionSummary ? `
      <div class="detail-section" style="background: rgba(76, 175, 80, 0.15); border-radius: 12px; padding: 20px; border: 1px solid rgba(76, 175, 80, 0.3);">
        <h3 style="color: #4caf50; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
          ‚úÖ Agent Execution Complete
        </h3>
        
        <!-- Cost and Duration Summary -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
          <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Duration</div>
            <div style="font-size: 18px; font-weight: bold; color: var(--accent-blue);">${task.completionSummary.durationMinutes} min</div>
          </div>
          <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Cost</div>
            <div style="font-size: 18px; font-weight: bold; color: var(--accent-green);">$${(task.completionSummary.cost || 0).toFixed(3)}</div>
          </div>
          <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Steps</div>
            <div style="font-size: 18px; font-weight: bold; color: var(--accent-orange);">${task.completionSummary.stepsCompleted}/${task.completionSummary.totalSteps}</div>
          </div>
        </div>
        
        ${task.completionSummary.urls && task.completionSummary.urls.length > 0 ? `
          <div style="margin-bottom: 16px; background: rgba(74, 144, 217, 0.2); padding: 16px; border-radius: 8px;">
            <strong style="color: var(--accent-blue);">üîó URLs Created:</strong>
            <ul style="margin: 8px 0 0 0; padding-left: 0; list-style: none;">
              ${task.completionSummary.urls.map(url => `
                <li style="margin: 6px 0; display: flex; align-items: center; gap: 8px;">
                  <a href="${escapeHtml(url)}" target="_blank" style="color: var(--accent-blue); text-decoration: underline; font-size: 13px; word-break: break-all; flex: 1;">
                    ${escapeHtml(url)}
                  </a>
                  <button class="btn btn-small btn-secondary" style="padding: 4px 12px; font-size: 10px;"
                          onclick="navigator.clipboard.writeText('${escapeHtml(url)}'); showToast('URL copied!', 'success');">Copy</button>
                </li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
        
        <!-- Output Files -->
        ${task.completionSummary.outputFiles && task.completionSummary.outputFiles.length > 0 && !task.completionSummary.outputFiles.includes('No files generated') ? `
          <div style="margin-bottom: 16px; background: rgba(255, 152, 0, 0.15); padding: 16px; border-radius: 8px; border: 1px solid rgba(255, 152, 0, 0.3);">
            <strong style="color: var(--accent-orange);">üìÅ Output Files:</strong>
            <ul style="margin: 10px 0 0 0; padding-left: 0; list-style: none;">
              ${task.completionSummary.outputFiles.map(file => `
                <li style="margin: 6px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 16px;">üìÑ</span>
                  <code style="flex: 1; font-size: 12px; color: var(--text-primary);">${escapeHtml(file)}</code>
                  <button class="btn btn-small btn-secondary" style="padding: 4px 12px; font-size: 10px;"
                          onclick="navigator.clipboard.writeText('${escapeHtml(file)}'); showToast('Path copied!', 'success');">Copy</button>
                </li>
              `).join('')}
            </ul>
            <div style="margin-top: 12px; padding: 10px; background: rgba(74, 144, 217, 0.1); border-radius: 6px;">
              <strong style="font-size: 11px; color: var(--text-secondary);">üìÇ Finder Location:</strong>
              <code style="display: block; margin-top: 6px; font-size: 11px; color: var(--accent-blue); cursor: pointer;" 
                    onclick="navigator.clipboard.writeText('${task.completionSummary.finderPath}'); showToast('Path copied!', 'success');">
                ${task.completionSummary.finderPath} <span style="margin-left: 4px;">üìã</span>
              </code>
            </div>
          </div>
        ` : ''}
        
        <!-- What Was Accomplished -->
        <div style="margin-bottom: 16px;">
          <strong style="color: var(--text-primary);">üìù What Was Accomplished:</strong>
          <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; margin-top: 10px; font-size: 13px; line-height: 1.6; white-space: pre-wrap;">${escapeHtml(task.completionSummary.whatWasAccomplished)}</div>
        </div>
        
        <!-- Footer Info -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: var(--text-secondary);">
          <span>Completed: ${new Date(task.completionSummary.completedAt).toLocaleString()}</span>
          <span>Task ID: ${task.completionSummary.taskId.substring(0, 8)}...</span>
        </div>
      </div>
    ` : ''}
  `;
  
  // Show attached files section if task has files
  const filesSection = document.getElementById('attachedFilesSection');
  const filesList = document.getElementById('attachedFilesList');
  
  if (task.files && task.files.length > 0) {
    filesSection.style.display = 'block';
    try {
      const response = await fetch(`${API_BASE}/files?taskId=${taskId}`);
      const data = await response.json();
      
      filesList.innerHTML = data.files.map(file => `
        <div class="file-tag" onclick="viewFile('${file.id}')">
          ${file.mimetype.startsWith('image/') ? `üì∑` : 'üìÑ'}
          ${file.filename}
        </div>
      `).join('');
    } catch (err) {
      console.error('Error loading attached files:', err);
    }
  } else {
    filesSection.style.display = 'none';
  }
  
  document.getElementById('detailModal').classList.add('active');
}

// ============================================
// PHASE 2: AGENT EXECUTION FUNCTIONS
// ============================================

async function updateTaskAgentType(taskId, agentType) {
  try {
    const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentType })
    });
    if (!response.ok) throw new Error('Failed to update agent type');
    const updatedTask = await response.json();
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    if (taskIndex !== -1) tasks[taskIndex] = updatedTask;
    showToast(`Agent type: ${agentType}`, 'success');
  } catch (err) {
    console.error('Error updating agent type:', err);
    showToast('Failed to update agent type', 'error');
  }
}

async function updateTaskPlanFirst(taskId, planFirst) {
  try {
    const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ planFirst })
    });
    if (!response.ok) throw new Error('Failed to update plan first');
    const updatedTask = await response.json();
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    if (taskIndex !== -1) tasks[taskIndex] = updatedTask;
    showToast(planFirst ? 'Planning enabled' : 'Planning disabled', 'success');
  } catch (err) {
    console.error('Error updating plan first:', err);
    showToast('Failed to update setting', 'error');
  }
}

async function startTaskExecution(taskId) {
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  
  if (task.executionStatus === 'executing' || task.executionStatus === 'planning') {
    showToast('Task is already running', 'warning');
    return;
  }
  
  try {
    showToast('Starting...', 'success');
    
    // Get fresh task data
    const response = await fetch(`${API_BASE}/tasks/${taskId}`);
    const freshTask = await response.json();
    
    // Check if plan already exists and is ready
    const planResponse = await fetch(`${API_BASE}/plans/${taskId}`);
    const planData = planResponse.ok ? await planResponse.json() : null;
    const planExists = planData && planData.plan && planData.plan.metadata && planData.plan.metadata.status === 'plan-ready';
    
    if (planExists) {
      // Plan exists - execute it
      showToast('Plan found - starting execution', 'success');
      const execResponse = await fetch(`${API_BASE}/plans/${taskId}/execute`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      if (!execResponse.ok) {
        const error = await execResponse.json();
        throw new Error(error.message || 'Failed to start execution');
      }
      showExecutionProgress(taskId);
    } else if (freshTask.planFirst) {
      // No plan yet - create one
      const planResponse = await fetch(`${API_BASE}/plans/${taskId}/planning`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      if (!planResponse.ok) throw new Error('Failed to start planning');
      showToast('Planning started', 'success');
      pollPlanStatus(taskId);
    } else {
      // No plan exists and planFirst is not checked - execute directly
      showToast('Starting direct execution...', 'success');
      const execResponse = await fetch(`${API_BASE}/plans/${taskId}/execute`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      if (!execResponse.ok) {
        const error = await execResponse.json();
        throw new Error(error.message || 'Failed to start execution');
      }
      showExecutionProgress(taskId);
    }
    
    await loadTasks();
    await loadActiveSessions();
    
  } catch (err) {
    console.error('Error starting execution:', err);
    showToast('Failed to start', 'error');
  }
}

async function pollPlanStatus(taskId) {
  const pollInterval = setInterval(async () => {
    try {
      const response = await fetch(`${API_BASE}/plans/${taskId}`);
      if (!response.ok) return;
      const plan = await response.json();
      
      if (plan.status === 'plan-ready') {
        clearInterval(pollInterval);
        showPlanReviewModal(taskId);
      } else if (plan.status === 'error') {
        clearInterval(pollInterval);
        showToast('Planning failed', 'error');
      }
      await loadTasks();
      await loadActiveSessions();
    } catch (err) {
      console.error('Error polling:', err);
    }
  }, 2000);
  
  setTimeout(() => clearInterval(pollInterval), 300000);
}

function showPlanReviewModal(taskId) {
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  
  document.getElementById('planReviewTaskTitle').textContent = task.title;
  document.getElementById('planMetaAgent').textContent = task.agentType || 'Auto';
  document.getElementById('planMetaCreated').textContent = new Date().toLocaleString();
  
  fetch(`${API_BASE}/plans/${taskId}`)
    .then(res => res.json())
    .then(data => {
      const plan = data.plan || {};
      document.getElementById('planMetaSteps').textContent = plan.stepCount || 0;
      document.getElementById('planReviewContent').innerHTML = formatPlanContent(plan);
    })
    .catch(() => {
      document.getElementById('planReviewContent').innerHTML = '<p style="color: var(--accent-red);">Failed to load plan</p>';
    });
  
  document.getElementById('planReviewModal').dataset.taskId = taskId;
  document.getElementById('planReviewModal').classList.add('active');
}

function formatPlanContent(plan) {
  if (!plan || !plan.content) return '<p>No plan content available</p>';
  const lines = plan.content.split('\n');
  let html = '<div class="plan-content">';
  lines.forEach(line => {
    if (line.startsWith('### Step')) {
      html += `<h4 style="color: var(--accent-blue); margin: 12px 0 8px;">${line.replace(/#/g, '').trim()}</h4>`;
    } else if (line.startsWith('## ')) {
      html += `<h3 style="margin: 16px 0 8px;">${line.replace(/## /, '').trim()}</h3>`;
    } else if (line.trim()) {
      html += `<p style="margin: 4px 0;">${line}</p>`;
    }
  });
  html += '</div>';
  return html;
}

function closePlanReviewModal() {
  document.getElementById('planReviewModal').classList.remove('active');
}

async function approveAndExecute() {
  const modal = document.getElementById('planReviewModal');
  const taskId = modal.dataset.taskId;
  closePlanReviewModal();
  
  try {
    const response = await fetch(`${API_BASE}/plans/${taskId}/approve`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' }
    });
    if (!response.ok) throw new Error('Failed to approve');
    showToast('Plan approved - executing', 'success');
    showExecutionProgress(taskId);
  } catch (err) {
    console.error('Error approving:', err);
    showToast('Failed to approve plan', 'error');
  }
}

function showExecutionProgress(taskId) {
  const panel = document.getElementById('executionProgress');
  panel.style.display = 'block';
  let progress = 0;
  const progressFill = document.getElementById('executionProgressFill');
  const progressText = document.getElementById('executionProgressText');
  
  const updateProgress = setInterval(() => {
    progress += Math.random() * 15;
    if (progress >= 100) {
      progress = 100;
      clearInterval(updateProgress);
      progressText.textContent = 'Complete!';
      setTimeout(hideExecutionProgress, 2000);
    } else {
      progressText.textContent = `Executing... ${Math.round(progress)}%`;
    }
    progressFill.style.width = `${progress}%`;
  }, 1000);
}

function hideExecutionProgress() {
  document.getElementById('executionProgress').style.display = 'none';
}

async function loadActiveSessions() {
  try {
    const response = await fetch(`${API_BASE}/sessions/active`);
    if (!response.ok) throw new Error('Failed');
    const data = await response.json();
    renderSessions(data.sessions || []);
  } catch (err) {
    console.error('Error loading sessions:', err);
    renderSessions([]);
  }
}

function renderSessions(sessions) {
  // Update horizontal agent list (in top bar) - ONLY
  const horizontalContainer = document.getElementById('horizontalAgentList');
  const horizontalCount = document.getElementById('activeAgentCount');
  
  // Safety check - elements may not exist
  if (!horizontalContainer || !horizontalCount) {
    console.warn('Active agents DOM elements not found');
    return;
  }
  
  horizontalCount.textContent = sessions.length;
  
  if (!sessions || sessions.length === 0) {
    horizontalContainer.innerHTML = `
      <div class="empty-agents">
        <span class="empty-icon">ü§ñ</span>
        <p>No active agents</p>
        <p style="font-size: 12px; opacity: 0.7;">Start a task to see it here</p>
      </div>`;
  } else {
    horizontalContainer.innerHTML = sessions.map(session => `
      <div class="horizontal-agent-card ${session.status}" id="h-session-${session.id}">
        <div class="agent-card-header">
          <span class="agent-card-type">${session.type === 'planning' ? 'üìù Planning' : '‚ö° Executing'}</span>
          <span style="font-size: 10px; color: var(--text-secondary);">${session.agentType || 'auto'}</span>
        </div>
        <div class="agent-card-title">${escapeHtml(session.taskTitle || 'Untitled')}</div>
        <div class="agent-card-status">
          ${session.currentStepModel ? `ü§ñ ${session.currentStepModel}` : 'Initializing...'}
          ${session.currentStep ? `‚Ä¢ Step ${session.currentStep}` : ''}
        </div>
        <div class="agent-card-actions">
          <button class="agent-btn-kill" onclick="killSession('${session.id}')">‚èπÔ∏è Stop</button>
        </div>
      </div>
    `).join('');
  }
}

async function refreshSessions() {
  showToast('Refreshing sessions...', 'success');
  await loadActiveSessions();  // Refresh active agents
  await loadSessionHistory();  // Refresh past sessions
}

async function killSession(sessionId) {
  if (!confirm('Stop this agent?')) return;
  try {
    const response = await fetch(`${API_BASE}/sessions/${sessionId}/kill`, {
      method: 'POST'
    });
    if (!response.ok) throw new Error('Failed');
    showToast('Session terminated', 'success');
    await loadActiveSessions();
    await loadTasks();
  } catch (err) {
    console.error('Error killing session:', err);
    showToast('Failed to terminate', 'error');
  }
}

// ============================================
// PAST SESSIONS HISTORY
// ============================================

async function loadSessionHistory() {
  try {
    const response = await fetch(`${API_BASE}/sessions/history?limit=10`);
    if (!response.ok) throw new Error('Failed');
    const data = await response.json();
    renderSessionHistory(data.sessions || [], data.totals);
  } catch (err) {
    console.error('Error loading session history:', err);
    renderSessionHistory([], {});
  }
}

function renderSessionHistory(sessions, totals) {
  // Update horizontal session list (in top bar) - ONLY
  const horizontalContainer = document.getElementById('horizontalSessionList');
  const horizontalCount = document.getElementById('horizontalSessionCount');
  const horizontalTotals = document.getElementById('horizontalSessionTotals');
  
  // Safety check - elements may not exist
  if (!horizontalContainer || !horizontalCount || !horizontalTotals) {
    console.warn('Past sessions DOM elements not found');
    return;
  }
  
  horizontalCount.textContent = sessions.length;
  
  if (totals) {
    horizontalTotals.textContent = `Total: $${(totals.cost || 0).toFixed(3)} | ${totals.duration || 0} min`;
  }
  
  if (!sessions || sessions.length === 0) {
    horizontalContainer.innerHTML = `
      <div class="empty-agents">
        <span class="empty-icon">üìä</span>
        <p>No completed sessions</p>
        <p style="font-size: 12px; opacity: 0.7;">Execute tasks to see history</p>
      </div>`;
  } else {
    horizontalContainer.innerHTML = sessions.map(session => {
      const statusIcon = session.status === 'complete' ? '‚úÖ' : 
                        session.status === 'error' ? '‚ùå' : 
                        session.status === 'killed' ? '‚èπÔ∏è' : '‚úì';
      return `
        <div class="horizontal-session-card ${session.status}">
          <div class="session-card-header">
            <span style="font-size: 11px;">${statusIcon} ${session.type || 'Agent'}</span>
            <span style="font-size: 10px; color: var(--text-secondary);">${session.durationMinutes || 0} min</span>
          </div>
          <div class="session-card-title">${escapeHtml(session.taskTitle || 'Untitled')}</div>
          <div class="session-card-meta">
            <span>$${(session.estimatedCost || 0).toFixed(3)}</span>
            <span>${session.tokensUsed || 0} tokens</span>
          </div>
        </div>
      `;
    }).join('');
  }
}

// ============================================
// INITIALIZATION
// ============================================

// ============================================
// REPORTS & ARCHIVE FUNCTIONS
// ============================================

let currentReports = [];
let currentReportDetail = null;

async function loadReports() {
  try {
    const response = await fetch(`${API_BASE}/reports?limit=50`);
    const data = await response.json();
    currentReports = data.reports || [];
    renderReports();
  } catch (err) {
    console.error('Error loading reports:', err);
  }
}

function renderReports() {
  const container = document.getElementById('reportsContainer');
  const countEl = document.getElementById('reportCount');
  
  countEl.textContent = `${currentReports.length} report${currentReports.length !== 1 ? 's' : ''}`;
  
  if (currentReports.length === 0) {
    container.innerHTML = `
      <div class="empty-reports" id="emptyReports">
        <div class="empty-icon">üìã</div>
        <p>No completed tasks yet</p>
        <p style="font-size: 13px; margin-top: 8px; opacity: 0.7;">Execute tasks to see reports here</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = currentReports.map(report => {
    const isError = report.error || report.whatWasAccomplished?.includes('‚ùå EXECUTION FAILED');
    return `
    <div class="report-card ${isError ? 'error' : ''}" onclick="showReportDetail('${report.id}')" style="${isError ? 'border-left-color: var(--accent-red); background: rgba(244, 67, 54, 0.1);' : ''}">
      <div class="report-header">
        <div class="report-title">${isError ? '‚ùå ' : ''}${escapeHtml(report.title)}</div>
        <span class="report-priority priority-${report.priority.toLowerCase()}">${report.priority}</span>
      </div>
      
      <div class="report-stats">
        <div class="report-stat">
          <div class="report-stat-value" style="color: ${isError ? 'var(--accent-red)' : 'var(--accent-blue)'};">${report.durationMinutes}</div>
          <div class="report-stat-label">min</div>
        </div>
        <div class="report-stat">
          <div class="report-stat-value" style="color: ${isError ? 'var(--accent-red)' : 'var(--accent-green)'};">$${(report.cost || 0).toFixed(3)}</div>
          <div class="report-stat-label">cost</div>
        </div>
        <div class="report-stat">
          <div class="report-stat-value" style="color: ${isError ? 'var(--accent-red)' : 'var(--accent-orange)'};">${report.stepsCompleted}/${report.totalSteps}</div>
          <div class="report-stat-label">steps</div>
        </div>
      </div>
      
      ${isError ? `
        <div class="report-files" style="background: rgba(244, 67, 54, 0.15); padding: 8px; border-radius: 6px; margin-bottom: 10px;">
          <div class="report-files-title" style="color: var(--accent-red);">‚ö†Ô∏è Execution Failed</div>
        </div>
      ` : ''}
      
      ${report.outputFiles && report.outputFiles.length > 0 && !report.outputFiles.includes('No files generated') && !report.outputFiles.includes('No files generated - execution failed') ? `
        <div class="report-files">
          <div class="report-files-title">üìÅ Output Files:</div>
          <div class="report-file-list">
            ${report.outputFiles.slice(0, 3).map(f => `
              <span class="report-file-tag">${escapeHtml(f.split('/').pop())}</span>
            `).join('')}
            ${report.outputFiles.length > 3 ? `<span class="report-file-tag">+${report.outputFiles.length - 3} more</span>` : ''}
          </div>
        </div>
      ` : ''}
      
      <div class="report-footer">
        <span>${isError ? 'Failed' : 'Completed'}: ${new Date(report.archivedAt).toLocaleDateString()}</span>
        <span>${report.agentType || 'auto'}</span>
      </div>
    </div>
  `}).join('');
}

async function refreshReports() {
  showToast('Refreshing reports...', 'success');
  await loadReports();
}

function showReportDetail(reportId) {
  const report = currentReports.find(r => r.id === reportId);
  if (!report) return;
  
  currentReportDetail = report;
  const isError = report.error || report.whatWasAccomplished?.includes('‚ùå EXECUTION FAILED');
  
  const content = document.getElementById('reportDetailContent');
  content.innerHTML = `
    <div class="detail-section" style="background: ${isError ? 'rgba(244, 67, 54, 0.1)' : 'rgba(76, 175, 80, 0.1)'}; border-radius: 12px; padding: 20px; border: 1px solid ${isError ? 'var(--accent-red)' : 'rgba(76, 175, 80, 0.3)'};">
      <h3 style="color: ${isError ? 'var(--accent-red)' : 'var(--accent-green)'}; margin-bottom: 16px;">
        ${isError ? '‚ùå ' : ''}${escapeHtml(report.title)}
      </h3>
      
      ${report.description ? `<p style="margin-bottom: 16px; color: var(--text-secondary);">${escapeHtml(report.description)}</p>` : ''}
      
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Duration</div>
          <div style="font-size: 20px; font-weight: bold; color: ${isError ? 'var(--accent-red)' : 'var(--accent-blue)'};">${report.durationMinutes} min</div>
        </div>
        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Cost</div>
          <div style="font-size: 20px; font-weight: bold; color: ${isError ? 'var(--accent-red)' : 'var(--accent-green)'};">$${(report.cost || 0).toFixed(3)}</div>
        </div>
        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Steps</div>
          <div style="font-size: 20px; font-weight: bold; color: ${isError ? 'var(--accent-red)' : 'var(--accent-orange)'};">${report.stepsCompleted}/${report.totalSteps}</div>
        </div>
        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Priority</div>
          <div style="font-size: 20px; font-weight: bold; color: var(--accent-${report.priority.toLowerCase() === 'p0' ? 'red' : report.priority.toLowerCase() === 'p1' ? 'orange' : report.priority.toLowerCase() === 'p2' ? 'yellow' : 'green'});">${report.priority}</div>
        </div>
      </div>
      
      ${report.tags && report.tags.length > 0 ? `
        <div style="margin-bottom: 16px;">
          <strong style="font-size: 12px; color: var(--text-secondary);">Tags:</strong>
          <div class="task-tags" style="margin-top: 6px;">
            ${report.tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('')}
          </div>
        </div>
      ` : ''}
      
      ${report.outputFiles && report.outputFiles.length > 0 && !report.outputFiles.includes('No files generated') ? `
        <div style="margin-bottom: 16px; background: rgba(255, 152, 0, 0.1); padding: 16px; border-radius: 8px;">
          <strong style="color: var(--accent-orange);">üìÅ Output Files:</strong>
          <ul style="margin: 10px 0 0 0; padding-left: 0; list-style: none;">
            ${report.outputFiles.map(file => `
              <li style="margin: 6px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 16px;">üìÑ</span>
                <code style="flex: 1; font-size: 12px;">${escapeHtml(file)}</code>
                <button class="btn btn-small btn-secondary" style="padding: 4px 12px; font-size: 10px;"
                        onclick="event.stopPropagation(); navigator.clipboard.writeText('${escapeHtml(file)}'); showToast('Path copied!', 'success');">Copy</button>
              </li>
            `).join('')}
          </ul>
          <div style="margin-top: 12px; padding: 10px; background: rgba(74, 144, 217, 0.1); border-radius: 6px;">
            <strong style="font-size: 11px; color: var(--text-secondary);">üìÇ Finder:</strong>
            <code style="display: block; margin-top: 6px; font-size: 11px; color: var(--accent-blue); cursor: pointer;" 
                  onclick="navigator.clipboard.writeText('${report.finderPath}'); showToast('Path copied!', 'success');">
              ${report.finderPath} üìã
            </code>
          </div>
        </div>
      ` : ''}
      
      ${report.urls && report.urls.length > 0 ? `
        <div style="margin-bottom: 16px; background: rgba(74, 144, 217, 0.1); padding: 16px; border-radius: 8px;">
          <strong style="color: var(--accent-blue);">üîó URLs:</strong>
          <ul style="margin: 10px 0 0 0; padding-left: 0; list-style: none;">
            ${report.urls.map(url => `
              <li style="margin: 6px 0;">
                <a href="${escapeHtml(url)}" target="_blank" style="color: var(--accent-blue); text-decoration: underline; font-size: 13px; word-break: break-all;">
                  ${escapeHtml(url)}
                </a>
              </li>
            `).join('')}
          </ul>
        </div>
      ` : ''}
      
      ${isError && report.logs && report.logs.length > 0 ? `
        <div style="margin-bottom: 16px;">
          <strong style="font-size: 12px; color: var(--accent-red);">üìã Execution Logs:</strong>
          <div style="background: rgba(0,0,0,0.3); padding: 16px; border-radius: 8px; margin-top: 10px; font-family: monospace; font-size: 11px; line-height: 1.5; max-height: 200px; overflow-y: auto; white-space: pre-wrap;">${escapeHtml(report.logs.join('\n'))}</div>
        </div>
      ` : ''}
      
      ${isError && report.errorMessage ? `
        <div style="margin-bottom: 16px;">
          <strong style="font-size: 12px; color: var(--accent-red);">‚ùå Error Details:</strong>
          <div style="background: rgba(244, 67, 54, 0.15); padding: 16px; border-radius: 8px; margin-top: 10px; font-size: 13px; line-height: 1.6; border: 1px solid var(--accent-red);">
            ${escapeHtml(report.errorMessage)}
          </div>
        </div>
      ` : ''}
      
      ${report.outputFiles && report.outputFiles.length > 0 ? `
        <div style="margin-bottom: 16px;">
          <strong style="font-size: 12px; color: var(--text-secondary);">üìÅ Output Files:</strong>
          <div style="margin-top: 10px;">
            ${report.outputFiles.filter(f => !f.includes('step-') && !f.includes('.prompt-') && !f.includes('No files')).map(file => `
              <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 8px;">
                <span style="font-size: 16px;">${file.endsWith('.html') ? 'üåê' : file.endsWith('.md') ? 'üìù' : file.endsWith('.json') ? 'üìã' : file.endsWith('.js') ? '‚ö°' : file.endsWith('.css') ? 'üé®' : 'üìÑ'}</span>
                <code style="flex: 1; font-size: 12px;">${escapeHtml(file.split('/').pop())}</code>
                <button class="btn btn-small btn-primary" style="padding: 4px 12px; font-size: 10px;" onclick="window.open('file://${escapeHtml(file.replace('~', '/Users/clawmachine'))}', '_blank')">Open</button>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      <div style="margin-bottom: 16px;">
        <strong style="font-size: 12px; color: var(--text-secondary);">üìù Summary:</strong>
        <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; margin-top: 10px; font-size: 13px; line-height: 1.6;">${formatAccomplished(report.whatWasAccomplished)}</div>
      </div>
      
      ${report.agentPrompts && report.agentPrompts.length > 0 ? `
        <div style="margin-bottom: 16px;">
          <strong style="font-size: 12px; color: var(--text-secondary);">ü§ñ Agent Prompts (${report.agentPrompts.length}):</strong>
          <div style="margin-top: 10px;">
            ${report.agentPrompts.map((p, i) => `
              <div style="margin-bottom: 12px; background: rgba(74, 144, 217, 0.1); border-radius: 8px; border: 1px solid rgba(74, 144, 217, 0.3);">
                <div style="background: rgba(74, 144, 217, 0.2); padding: 8px 12px; border-radius: 8px 8px 0 0; font-size: 11px; font-weight: 600; color: var(--accent-blue);">
                  Step ${p.step}: ${escapeHtml(p.title)} (${p.agent})
                </div>
                <div style="padding: 12px; font-family: monospace; font-size: 10px; line-height: 1.5; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${escapeHtml(p.prompt)}</div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      <div style="display: flex; justify-content: space-between; padding-top: 16px; border-top: 1px solid var(--border-color); font-size: 11px; color: var(--text-secondary);">
        <span>Created: ${new Date(report.created).toLocaleString()}</span>
        <span>${isError ? 'Failed' : 'Archived'}: ${new Date(report.archivedAt).toLocaleString()}</span>
      </div>
    </div>
  `;
  
  document.getElementById('reportDetailModal').classList.add('active');
}

function formatAccomplished(text) {
  if (!text) return '<em>No details available</em>';
  
  // Remove system metadata blocks
  let cleaned = text
    .replace(/System:\s*\[.*?\]\s*Exec completed.*\n?/gi, '')
    .replace(/Meta:\s*\{.*?\}\n?/gis, '')
    .replace(/"sessionId".*?"totalTokens".*?\}\n?/gis, '')
    .replace(/\{[^}]*"model"[^}]*\}/g, '')
    .replace(/Usage:.*?\n?/gi, '')
    .replace(/provider:.*?\n?/gi, '')
    .replace(/Cost:.*?\n?/gi, '');
  
  // Format step completions
  cleaned = cleaned
    .replace(/‚úì\s*(Step \d+):/g, '<strong style="color: var(--accent-green);">‚úì $1:</strong>')
    .replace(/Files Created:\s*None/gi, '')
    .replace(/URLs:\s*None/gi, '')
    .replace(/Notes:\s*None/gi, '');
  
  // Trim and limit length
  cleaned = cleaned.trim();
  
  // Split into paragraphs
  const paragraphs = cleaned.split('\n').filter(p => p.trim());
  
  if (paragraphs.length === 0) return '<em>No details available</em>';
  
  // Return as HTML paragraphs
  return paragraphs.map(p => `<p style="margin-bottom: 8px;">${escapeHtml(p).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>`).join('');
}

function closeReportDetailModal() {
  document.getElementById('reportDetailModal').classList.remove('active');
  currentReportDetail = null;
}

async function restoreFromReport() {
  if (!currentReportDetail) return;
  
  try {
    const response = await fetch(`${API_BASE}/archive/${currentReportDetail.taskId}/restore`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (!response.ok) throw new Error('Failed to restore');
    
    showToast('Task restored to backlog', 'success');
    closeReportDetailModal();
    await loadTasks();
    await loadArchive();
  } catch (err) {
    console.error('Error restoring task:', err);
    showToast('Failed to restore task', 'error');
  }
}

async function clearAllReports() {
  if (!confirm('Delete all reports? This cannot be undone.')) return;
  
  try {
    for (const report of currentReports) {
      await fetch(`${API_BASE}/reports/${report.id}`, { method: 'DELETE' });
    }
    showToast('All reports cleared', 'success');
    await loadReports();
  } catch (err) {
    console.error('Error clearing reports:', err);
    showToast('Failed to clear reports', 'error');
  }
}

// ============================================
// ARCHIVE FUNCTIONS
// ============================================

let archivedTasks = [];

async function loadArchive() {
  try {
    const response = await fetch(`${API_BASE}/archive?limit=100`);
    const data = await response.json();
    archivedTasks = data.archived || [];
  } catch (err) {
    console.error('Error loading archive:', err);
  }
}

function showArchiveView() {
  renderArchiveList();
  document.getElementById('archiveModal').classList.add('active');
}

function closeArchiveModal() {
  document.getElementById('archiveModal').classList.remove('active');
}

function renderArchiveList() {
  const container = document.getElementById('archiveList');
  
  if (archivedTasks.length === 0) {
    container.innerHTML = `
      <div class="empty-reports">
        <div class="empty-icon">üì¶</div>
        <p>No archived tasks</p>
        <p style="font-size: 13px; margin-top: 8px; opacity: 0.7;">Completed tasks appear here</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = archivedTasks.map(task => `
    <div class="archive-item">
      <div class="archive-item-info">
        <div class="archive-item-title">${escapeHtml(task.title)}</div>
        <div class="archive-item-meta">
          ${task.priority} ‚Ä¢ Archived: ${new Date(task.archivedAt).toLocaleDateString()} ‚Ä¢ 
          ${task.completionSummary ? `$${(task.completionSummary.cost || 0).toFixed(3)} ‚Ä¢ ${task.completionSummary.durationMinutes}min` : 'No execution data'}
        </div>
      </div>
      <div class="archive-item-actions">
        <button class="btn btn-small btn-secondary" onclick="restoreArchivedTask('${task.id}')">üì¶ Restore</button>
        <button class="btn btn-small" style="background: var(--accent-red); color: white;" onclick="deleteArchivedTask('${task.id}')">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}

async function restoreArchivedTask(taskId) {
  try {
    const response = await fetch(`${API_BASE}/archive/${taskId}/restore`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (!response.ok) throw new Error('Failed to restore');
    
    showToast('Task restored to backlog', 'success');
    await loadArchive();
    renderArchiveList();
    await loadTasks();
  } catch (err) {
    console.error('Error restoring task:', err);
    showToast('Failed to restore task', 'error');
  }
}

async function deleteArchivedTask(taskId) {
  if (!confirm('Permanently delete this task from archive?')) return;
  
  try {
    const response = await fetch(`${API_BASE}/archive/${taskId}`, { method: 'DELETE' });
    if (!response.ok) throw new Error('Failed to delete');
    
    showToast('Task deleted from archive', 'success');
    await loadArchive();
    renderArchiveList();
  } catch (err) {
    console.error('Error deleting task:', err);
    showToast('Failed to delete task', 'error');
  }
}

// ============================================

async function init() {
  await loadTasks();
  await loadActiveSessions();  // Load active agent sessions
  await loadSessionHistory();  // Load past agent sessions
  await loadReports();
  await loadArchive();
  // initSortable() is now called inside loadTasks()
  initFilters();
  initSearch();
  initPrioritySelector();
  initKeyboardShortcuts();
  initWebSocket();
  
  console.log('üöÄ Kanban Board initialized');
}

init();
  </script>
</body>
</html>
